<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>Wallet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* reset */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.35}
    img{max-width:100%;display:block}
    button,input,select,textarea{font:inherit;color:inherit}
    a{color:inherit;text-decoration:none}
    ::selection{background:rgba(120,170,255,.25)}
    :focus-visible{outline:2px solid var(--focus);outline-offset:2px;border-radius:12px}

    /* theme */
    :root{
      --bg:#0b0c0f; --bg2:#0f1117;
      --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.10); --stroke2:rgba(255,255,255,.16);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62); --muted2:rgba(255,255,255,.42);
      --shadow:0 18px 60px rgba(0,0,0,.45); --shadow2:0 10px 30px rgba(0,0,0,.28);
      --good:rgba(85,255,167,.95); --bad:rgba(255,92,92,.95); --warn:rgba(255,199,79,.98);
      --focus:rgba(124,200,255,.9);
      --radius:16px; --radius2:22px;
      --pad:16px; --pad2:20px;
      --tap:48px;
      --max:1080px;
      --blur: saturate(1.3) blur(16px);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --bg2:#ffffff;
      --card:rgba(10,12,20,.04); --card2:rgba(10,12,20,.06);
      --stroke:rgba(10,12,20,.10); --stroke2:rgba(10,12,20,.14);
      --text:rgba(10,12,20,.92); --muted:rgba(10,12,20,.62); --muted2:rgba(10,12,20,.42);
      --shadow:0 18px 60px rgba(10,12,20,.10); --shadow2:0 10px 30px rgba(10,12,20,.08);
      --good:rgba(0,168,93,.95); --bad:rgba(220,48,48,.95); --warn:rgba(210,140,0,.98);
      --focus:rgba(33,128,255,.85);
      --blur:saturate(1.2) blur(14px);
    }

    body{
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(110,170,255,.16), transparent 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(255,160,110,.10), transparent 55%),
        radial-gradient(900px 700px at 60% 110%, rgba(90,255,190,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .app{min-height:100%;display:flex;flex-direction:column}
    .topbar{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(to bottom, rgba(0,0,0,.25), transparent 75%);
      padding: calc(env(safe-area-inset-top) + 12px) 14px 10px;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-bottom:1px solid rgba(255,255,255,.04);
    }
    [data-theme="light"] .topbar{background:linear-gradient(to bottom, rgba(255,255,255,.65), transparent 75%);border-bottom:1px solid rgba(10,12,20,.06)}
    .topbarInner{max-width:var(--max);margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      display:grid;place-items:center;
    }
    [data-theme="light"] .logo{background:linear-gradient(135deg, rgba(10,12,20,.06), rgba(10,12,20,.03))}
    .brandTitle{font-weight:650;letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--card);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .chip strong{color:var(--text);font-weight:600}
    .actions{display:flex;align-items:center;gap:8px}
    .iconBtn{
      width:var(--tap);height:var(--tap);
      border-radius:14px;border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow2);
      display:grid;place-items:center;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .iconBtn:active{transform:scale(.98)}
    .iconBtn:hover{border-color:var(--stroke2)}
    .iconBtn[disabled]{opacity:.55;cursor:not-allowed}
    .icon{width:20px;height:20px;opacity:.92}
    .main{
      flex:1;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom) + 82px);
    }
    .container{max-width:var(--max);margin:0 auto}
    .grid{display:grid;gap:14px}
    @media (min-width:860px){
      .grid.cols2{grid-template-columns: 1.2fr .8fr}
      .grid.cols3{grid-template-columns: 1fr 1fr 1fr}
    }

    .card{
      background:linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHeader{padding:16px 16px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .cardTitle{font-size:14px;font-weight:650;letter-spacing:-.01em}
    .cardSub{font-size:12px;color:var(--muted);margin-top:4px}
    .cardBody{padding: 0 16px 16px}
    .divider{height:1px;background:rgba(255,255,255,.06)}
    [data-theme="light"] .divider{background:rgba(10,12,20,.07)}

    .btn{
      height:var(--tap);
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow2);
      display:inline-flex;align-items:center;justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition:transform .12s ease, border-color .12s ease, background .12s ease, opacity .12s ease;
      font-weight:600;
      letter-spacing:-.01em;
    }
    .btn:hover{border-color:var(--stroke2)}
    .btn:active{transform:scale(.99)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;transform:none}
    .btn.primary{
      border-color:rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
    }
    [data-theme="light"] .btn.primary{
      border-color:rgba(10,12,20,.16);
      background:linear-gradient(180deg, rgba(10,12,20,.08), rgba(10,12,20,.04));
    }
    .btn.danger{
      border-color:rgba(255,92,92,.25);
      background:linear-gradient(180deg, rgba(255,92,92,.20), rgba(255,92,92,.08));
    }
    .btn.ghost{background:transparent;box-shadow:none}
    .btn.small{height:40px;border-radius:12px;font-size:13px}
    .btn.full{width:100%}

    .field{display:grid;gap:6px;margin-top:12px}
    .label{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .input, .select, .textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.16);
      padding: 12px 12px;
      min-height:var(--tap);
      outline:none;
      transition:border-color .12s ease, background .12s ease;
      color:var(--text);
    }
    [data-theme="light"] .input, [data-theme="light"] .select, [data-theme="light"] .textarea{
      background:rgba(255,255,255,.78);
    }
    .textarea{min-height:96px;resize:vertical}
    .input:focus, .select:focus, .textarea:focus{border-color:rgba(124,200,255,.55)}
    .help{font-size:12px;color:var(--muted2);margin-top:2px}
    .err{font-size:12px;color:var(--bad);margin-top:2px}
    .row{display:flex;gap:12px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .row.between{justify-content:space-between}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums; font-feature-settings:"tnum" 1, "ss01" 1}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      font-size:12px;color:var(--muted);
    }
    [data-theme="light"] .pill{background:rgba(255,255,255,.65)}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      font-size:11px;color:var(--muted);white-space:nowrap;
    }
    .badge.good{border-color:rgba(85,255,167,.25);color:var(--good)}
    .badge.bad{border-color:rgba(255,92,92,.25);color:var(--bad)}
    .badge.warn{border-color:rgba(255,199,79,.25);color:var(--warn)}
    .badge.soft{background:transparent}

    .seg{
      display:flex;gap:6px;
      padding:6px;border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
    }
    [data-theme="light"] .seg{background:rgba(255,255,255,.65)}
    .seg button{
      flex:1;height:42px;border-radius:12px;
      border:1px solid transparent;
      background:transparent;color:var(--muted);
      cursor:pointer;
      font-weight:650;
      transition:background .12s ease, color .12s ease, border-color .12s ease;
    }
    .seg button[aria-pressed="true"]{
      color:var(--text);
      background:linear-gradient(180deg, var(--card2), var(--card));
      border-color:var(--stroke);
      box-shadow: var(--shadow2);
    }

    .bottomNav{
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-top:1px solid rgba(255,255,255,.06);
      background:linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,.18));
    }
    [data-theme="light"] .bottomNav{
      border-top:1px solid rgba(10,12,20,.08);
      background:linear-gradient(to top, rgba(255,255,255,.85), rgba(255,255,255,.60));
    }
    .navInner{
      max-width:var(--max);margin:0 auto;
      display:grid;grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    .tabBtn{
      height:62px;border-radius:18px;
      border:1px solid transparent;
      background:transparent;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;
      color:var(--muted);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      transition:background .12s ease, border-color .12s ease, transform .12s ease, color .12s ease;
      position:relative;
    }
    .tabBtn:active{transform:scale(.985)}
    .tabBtn[aria-current="page"]{
      color:var(--text);
      border-color:var(--stroke);
      background:linear-gradient(180deg, var(--card2), var(--card));
      box-shadow: var(--shadow2);
    }
    .tabLabel{font-size:11px;font-weight:650;letter-spacing:-.01em}
    .dot{
      position:absolute;top:10px;right:16px;
      min-width:18px;height:18px;padding:0 5px;
      border-radius:999px;
      background:rgba(255,92,92,.95);
      color:white;
      display:none;
      align-items:center;justify-content:center;
      font-size:11px;font-weight:750;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .tabBtn.hasDot .dot{display:inline-flex}

    .banner{
      padding:12px 12px;border-radius:16px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,199,79,.20), rgba(255,199,79,.08));
      color:var(--text);
      display:flex;align-items:flex-start;gap:10px;
    }
    .banner .bTitle{font-weight:750}
    .banner .bSub{font-size:12px;color:var(--muted);margin-top:2px}

    .progress{
      width:100%;height:10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    [data-theme="light"] .progress{background:rgba(10,12,20,.06);border-color:rgba(10,12,20,.10)}
    .progress > div{
      height:100%;width:0%;
      background:linear-gradient(90deg, rgba(120,170,255,.85), rgba(90,255,190,.75));
      border-radius:999px;
      transition:width .25s ease;
    }

    .list{display:grid;gap:10px}
    .item{
      padding:12px;border-radius:18px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    [data-theme="light"] .item{background:linear-gradient(180deg, rgba(10,12,20,.04), rgba(10,12,20,.02))}
    .itemLeft{min-width:0;display:grid;gap:6px}
    .itemTitle{font-weight:700;letter-spacing:-.01em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .itemMeta{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .itemMeta .badge{max-width:100%}
    .itemRight{display:grid;gap:8px;justify-items:end}
    .amt{font-weight:800;letter-spacing:-.02em}
    .amt.small{font-size:14px}
    .amt.big{font-size:20px}
    .empty{
      padding:16px;border-radius:22px;border:1px dashed var(--stroke);
      background:rgba(0,0,0,.08);
      color:var(--muted);
      display:grid;gap:10px;
    }
    [data-theme="light"] .empty{background:rgba(255,255,255,.65)}
    .empty .eTitle{font-weight:750;color:var(--text)}
    .kpi{display:grid;gap:8px}
    .kpi .val{font-size:26px;font-weight:850;letter-spacing:-.03em}
    .kpi .cap{font-size:12px;color:var(--muted)}

    /* modal + sheet */
    .overlay{
      position:fixed;inset:0;z-index:60;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }
    .overlay.show{display:flex}
    .sheet{
      width:min(720px, 100%);
      border-radius:24px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--bg2), var(--bg));
      box-shadow: var(--shadow);
      overflow:hidden;
      transform:translateY(12px);
      opacity:0;
      transition:transform .18s ease, opacity .18s ease;
    }
    .overlay.show .sheet{transform:translateY(0);opacity:1}
    .sheetHeader{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .sheetHeader{border-bottom:1px solid rgba(10,12,20,.08)}
    .sheetTitle{font-weight:800;letter-spacing:-.02em}
    .sheetBody{padding: 10px 16px 16px; max-height: min(78vh, 720px); overflow:auto}
    .sheetFooter{padding: 12px 16px; border-top:1px solid rgba(255,255,255,.06); display:flex;gap:10px;justify-content:flex-end}
    [data-theme="light"] .sheetFooter{border-top:1px solid rgba(10,12,20,.08)}
    .modalCenter{align-items:center}
    .modalCenter .sheet{border-radius:26px}
    .sheetClose{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--card2), var(--card));
      display:grid;place-items:center;cursor:pointer;
    }

    /* toast */
    .toasts{
      position:fixed;left:0;right:0;top:0;z-index:80;
      padding: calc(env(safe-area-inset-top) + 12px) 12px 0;
      display:grid;gap:8px;
      pointer-events:none;
    }
    .toast{
      max-width: 720px;
      margin:0 auto;
      pointer-events:auto;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.30));
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: var(--shadow2);
      display:flex;align-items:flex-start;gap:10px;
      opacity:0;transform:translateY(-6px);
      animation:toastIn .18s ease forwards;
    }
    [data-theme="light"] .toast{background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80))}
    @keyframes toastIn{to{opacity:1;transform:translateY(0)}}
    .toast .tTitle{font-weight:800;letter-spacing:-.01em}
    .toast .tMsg{font-size:12px;color:var(--muted);margin-top:2px}
    .toast .tX{
      margin-left:auto;
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--stroke);
      background:transparent;display:grid;place-items:center;cursor:pointer;
    }

    /* auth */
    .centerWrap{min-height: calc(100vh - 90px); display:grid; place-items:center}
    .authCard{width:min(520px, 100%); padding: 16px}
    .authHero{padding: 10px 4px 4px}
    .authHero h1{margin:0;font-size:26px;letter-spacing:-.03em}
    .authHero p{margin:8px 0 0;color:var(--muted);font-size:13px}
    .authSwitch{display:flex;gap:8px;margin-top:12px}

    /* verification gate */
    .gate{
      position:fixed;inset:0;z-index:55;
      background:linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.12)), var(--bg);
      display:none;
      padding: calc(env(safe-area-inset-top) + 16px) 14px calc(env(safe-area-inset-bottom) + 18px);
      overflow:auto;
    }
    [data-theme="light"] .gate{background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65)), var(--bg)}
    .gate.show{display:block}
    .gateInner{max-width:640px;margin:0 auto;display:grid;gap:14px}
    .gateTitle{font-size:22px;font-weight:850;letter-spacing:-.03em;margin:0}
    .gateSub{color:var(--muted);font-size:13px;margin:0}

    /* receipt fullscreen */
    .imgView{
      width:min(920px, 100%);
      border-radius:24px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:var(--bg2);
      box-shadow: var(--shadow);
    }
    .imgView img{width:100%;height:auto;background:rgba(0,0,0,.12)}
    .imgViewHead{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    [data-theme="light"] .imgViewHead{border-bottom:1px solid rgba(10,12,20,.08)}
    .imgViewTitle{font-weight:800}

    /* cropper */
    .cropWrap{display:grid;gap:12px}
    .cropStage{
      width:100%;
      aspect-ratio:1/1;
      border-radius:22px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background:rgba(0,0,0,.12);
      position:relative;
      touch-action:none;
    }
    [data-theme="light"] .cropStage{background:rgba(255,255,255,.70)}
    canvas#cropCanvas{width:100%;height:100%}
    .cropHud{
      position:absolute;left:10px;right:10px;bottom:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      pointer-events:none;
    }
    .slider{
      flex:1;
      pointer-events:auto;
      height:40px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      display:flex;align-items:center;padding:0 12px;
    }
    [data-theme="light"] .slider{background:rgba(255,255,255,.70)}
    .slider input{width:100%}

    /* skeleton */
    .skel{
      background:linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05));
      background-size:200% 100%;
      animation:shimmer 1.15s linear infinite;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .skel{background:linear-gradient(90deg, rgba(10,12,20,.04), rgba(10,12,20,.08), rgba(10,12,20,.04));border-color:rgba(10,12,20,.06)}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .hintLine{height:14px}
    .hintBlock{height:52px}

    .smallNote{font-size:12px;color:var(--muted);margin-top:8px}
    .right{margin-left:auto}
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar" id="topbar">
      <div class="topbarInner">
        <div class="brand">
          <div class="logo" aria-hidden="true" title="Wallet">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M7.2 8.5h10.2c1.8 0 3.1 1.3 3.1 3.1v1.8c0 1.8-1.3 3.1-3.1 3.1H7.2c-2.1 0-3.7-1.6-3.7-3.7v-4.6c0-2.1 1.6-3.7 3.7-3.7Z" stroke="currentColor" stroke-width="1.6" opacity=".95"/>
              <path d="M16.4 12.1h2.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M7.2 8.5V7.1c0-1.2 1-2.2 2.2-2.2h7.2" stroke="currentColor" stroke-width="1.6" opacity=".7"/>
            </svg>
          </div>
          <div class="brandTitle" id="brandTitle">Wallet</div>
        </div>

        <div class="actions">
          <div class="chip" id="syncChip" title="Sync status">
            <span aria-hidden="true">●</span>
            <span id="syncText">Offline</span>
          </div>
          <button class="iconBtn" id="btnRefresh" type="button" aria-label="Refresh">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M20 5v6h-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="iconBtn" id="btnLogout" type="button" aria-label="Logout" title="Logout">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M10 7V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2v-1" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              <path d="M4 12h10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M7 9l-3 3 3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="container" id="viewRoot"></div>
    </div>

    <nav class="bottomNav" id="bottomNav" aria-label="Bottom navigation">
      <div class="navInner">
        <button class="tabBtn" data-tab="home" aria-current="page" type="button">
          <span class="dot" id="dotHome"></span>
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 11.4 12 4l8 7.4V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8.6Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            <path d="M9.5 22v-7.2a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2V22" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
          <div class="tabLabel">Home</div>
        </button>

        <button class="tabBtn" data-tab="txns" type="button">
          <span class="dot" id="dotTxns"></span>
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7h14M7 12h14M7 17h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M3.5 7h.01M3.5 12h.01M3.5 17h.01" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
          <div class="tabLabel">Transactions</div>
        </button>

        <button class="tabBtn" data-tab="friends" type="button">
          <span class="dot" id="dotFriends"></span>
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M16 11a4 4 0 1 0-8 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M4 20a6 6 0 0 1 16 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M19.5 8.5h3M21 7v3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
          <div class="tabLabel">Friends</div>
        </button>

        <button class="tabBtn" data-tab="notifs" type="button">
          <span class="dot" id="notifDot">0</span>
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 7-3 7h18s-3 0-3-7" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M10 19a2 2 0 0 0 4 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
          <div class="tabLabel">Notifications</div>
        </button>

        <button class="tabBtn" data-tab="profile" type="button">
          <span class="dot" id="dotProfile"></span>
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.7"/>
            <path d="M4 20a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
          <div class="tabLabel">Profile</div>
        </button>
      </div>
    </nav>
  </div>

  <!-- Gate -->
  <section class="gate" id="gate" aria-modal="true" role="dialog" aria-label="Verification required">
    <div class="gateInner">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 class="gateTitle">Verify phone & UPI</h2>
            <p class="gateSub">Required once before you can use the app. Used for settlements and paybacks.</p>
          </div>
        </div>
        <div class="cardBody">
          <div id="gateBanner" class="banner hide" role="status" aria-live="polite">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 9v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M12 17h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
              <path d="M10.3 4.6a2 2 0 0 1 3.4 0l7.1 12.3A2 2 0 0 1 19.1 20H4.9a2 2 0 0 1-1.7-3.1l7.1-12.3Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            </svg>
            <div>
              <div class="bTitle" id="gateBannerTitle">Heads up</div>
              <div class="bSub" id="gateBannerSub">Please verify to proceed.</div>
            </div>
          </div>

          <div class="field">
            <div class="label">Phone (10 digits)</div>
            <input class="input" id="gatePhone" inputmode="numeric" autocomplete="tel" placeholder="e.g. 9876543210" maxlength="10">
            <div class="err hide" id="gatePhoneErr"></div>
          </div>
          <div class="field">
            <div class="label">UPI ID</div>
            <input class="input" id="gateUpi" autocomplete="off" placeholder="e.g. name@bank">
            <div class="err hide" id="gateUpiErr"></div>
          </div>

          <div class="smallNote">You’ll see two confirmations before submitting.</div>

          <div class="row" style="margin-top:14px">
            <button class="btn primary full" id="gateSubmit" type="button">
              <span>Confirm & Continue</span>
              <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M5 12h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M13 6l6 6-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardBody">
          <div class="row between">
            <div class="muted">Logged in as</div>
            <div class="pill mono" id="gateUser"></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn danger full" id="gateLogout" type="button">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Overlay / Sheet -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Dialog">
    <div class="sheet" id="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle" id="sheetTitle">Dialog</div>
        <button class="sheetClose" id="sheetClose" type="button" aria-label="Close">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
      <div class="sheetFooter" id="sheetFooter"></div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* =========================
      CONFIG
    ========================== */
    const API_URL = "https://script.google.com/macros/s/AKfycbwp0m3voA1kNJk8OTMOXFHfXBEA1xKwgQXC9vvxU5gnOxcLoQlNyYGhRM9wU1C9Nts/exec";

    /* =========================
      STATE
    ========================== */
    const LS = {
      userId: "wallet_userId",
      me: "wallet_me",
      theme: "wallet_theme",
      lastTab: "wallet_lastTab"
    };

    const state = {
      session: { userId: null },
      me: null,
      categories: [],
      txns: [],
      notifs: [],
      friendSummaries: [],
      activeTab: "home",
      lastSyncAt: null,
      polling: { notifs: null, friends: null },
      busy: new Set(),
      cache: { friendDetail: null }
    };

    /* =========================
      UTIL
    ========================== */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function safeText(s){
      const str = (s === null || s === undefined) ? "" : String(s);
      return str.replace(/[<>&"]/g, c => ({ "<":"&lt;", ">":"&gt;", "&":"&amp;", '"':"&quot;" }[c]));
    }

    function fmtINR(n){
      const x = Number(n || 0);
      try { return x.toLocaleString("en-IN", { maximumFractionDigits: 2 }); }
      catch { return String(Math.round(x*100)/100); }
    }

    function relTime(iso){
      const t = new Date(iso).getTime();
      if (!isFinite(t)) return "";
      const d = Date.now() - t;
      const s = Math.floor(d/1000);
      if (s < 10) return "just now";
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h}h ago`;
      const days = Math.floor(h/24);
      if (days < 7) return `${days}d ago`;
      return new Date(iso).toLocaleDateString();
    }

    function setSyncStatus(ok, msg){
      const chip = $("#syncChip");
      const t = $("#syncText");
      if (!chip || !t) return;
      t.textContent = msg || (ok ? "Synced" : "Offline");
      chip.style.opacity = ok ? "1" : ".85";
      chip.style.borderColor = ok ? "rgba(85,255,167,.25)" : "var(--stroke)";
      chip.style.color = ok ? "var(--good)" : "var(--muted)";
      state.lastSyncAt = ok ? new Date().toISOString() : state.lastSyncAt;
      updateBrandSub();
    }

    function updateBrandSub(){
      const chip = $("#syncText");
      if (!chip) return;
      if (state.lastSyncAt) chip.textContent = `Synced ${relTime(state.lastSyncAt)}`;
    }

    function toast(title, msg, kind="info", ms=2800){
      const wrap = $("#toasts");
      if (!wrap) return;
      const el = document.createElement("div");
      el.className = "toast";
      const icon = kind === "good" ? `
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.0" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>` :
        kind === "bad" ? `
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2.0" stroke-linecap="round"/>
        </svg>` :
        kind === "warn" ? `
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 9v4" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
          <path d="M12 17h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
          <path d="M10.3 4.6a2 2 0 0 1 3.4 0l7.1 12.3A2 2 0 0 1 19.1 20H4.9a2 2 0 0 1-1.7-3.1l7.1-12.3Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
        </svg>` :
        `
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z" stroke="currentColor" stroke-width="1.7"/>
          <path d="M12 16v-5" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
          <path d="M12 8h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
        </svg>`;
      el.innerHTML = `
        <div style="margin-top:1px">${icon}</div>
        <div style="min-width:0">
          <div class="tTitle">${safeText(title || "Notice")}</div>
          <div class="tMsg">${safeText(msg || "")}</div>
        </div>
        <button class="tX" type="button" aria-label="Dismiss">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7l10 10M17 7 7 17" stroke="currentColor" stroke-width="2.0" stroke-linecap="round"/>
          </svg>
        </button>
      `;
      const x = $(".tX", el);
      x.addEventListener("click", () => el.remove());
      wrap.appendChild(el);
      window.setTimeout(() => { try{ el.remove(); }catch{} }, ms);
    }

    function setBusy(key, on){
      if (on) state.busy.add(key); else state.busy.delete(key);
    }
    function isBusy(key){ return state.busy.has(key); }

    function saveSession(){
      try{
        localStorage.setItem(LS.userId, state.session.userId || "");
        localStorage.setItem(LS.me, JSON.stringify(state.me || null));
      }catch{}
    }
    function loadSession(){
      try{
        const uid = localStorage.getItem(LS.userId) || "";
        const me = localStorage.getItem(LS.me) || "";
        state.session.userId = uid || null;
        state.me = me ? JSON.parse(me) : null;
      }catch{
        state.session.userId = null;
        state.me = null;
      }
    }
    function clearSession(){
      state.session.userId = null;
      state.me = null;
      try{ localStorage.removeItem(LS.userId); localStorage.removeItem(LS.me); }catch{}
    }

    function setTheme(theme){
      const t = theme === "light" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", t);
      try{ localStorage.setItem(LS.theme, t); }catch{}
    }
    function loadTheme(){
      const t = (localStorage.getItem(LS.theme) || "dark").toLowerCase();
      setTheme(t === "light" ? "light" : "dark");
    }

    function setLastTab(tab){
      try{ localStorage.setItem(LS.lastTab, tab); }catch{}
    }
    function loadLastTab(){
      return (localStorage.getItem(LS.lastTab) || "home");
    }

    function validatePhone(phone){
      const p = String(phone || "").replace(/\D/g, "");
      return p.length === 10 ? p : null;
    }
    function validateUpi(upi){
      const u = String(upi || "").trim();
      const ok = /^[\w.\-]{2,256}@[\w.\-]{2,64}$/.test(u);
      return ok ? u : null;
    }
    function validateRegisterPassword(pw){
      const p = String(pw || "");
      if (p.length < 8) return "Must be at least 8 characters.";
      return "";
    }
    function validateStrongPassword(pw){
      const p = String(pw || "");
      if (p.length < 8) return "Must be at least 8 characters.";
      if (!/[A-Za-z]/.test(p) || !/[0-9]/.test(p)) return "Must contain letters and numbers.";
      return "";
    }

    function dtLocalFromIso(iso){
      const d = iso ? new Date(iso) : new Date();
      if (!isFinite(d.getTime())) return "";
      const pad = (n)=> String(n).padStart(2,"0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    function isoFromLocal(dtLocal){
      if (!dtLocal) return new Date().toISOString();
      const d = new Date(dtLocal);
      return isFinite(d.getTime()) ? d.toISOString() : new Date().toISOString();
    }

    async function confirmTwoStep(){
      const step1 = window.confirm("Confirm phone + UPI. This is used for payments.");
      if (!step1) return false;
      const step2 = window.confirm("Are you absolutely sure? Wrong details may block settlements.");
      return !!step2;
    }

    /* =========================
      API
    ========================== */
    async function apiPing(){
      try{
        const r = await fetch(`${API_URL}?ping=1`, { method:"GET", cache:"no-store" });
        const j = await r.json().catch(()=>null);
        return !!(j && j.ok);
      }catch{ return false; }
    }

    async function apiCall(action, payload){
      const body = Object.assign({ action }, payload || {});
      let resp, text, json;
      try{
        resp = await fetch(API_URL, {
          method: "POST",
          // IMPORTANT: Do NOT set Content-Type to application/json.
          // Sending a raw string body keeps this a "simple request" and avoids CORS preflight against Apps Script.
          body: JSON.stringify(body),
          cache: "no-store"
        });
      }catch(e){
        setSyncStatus(false, "Offline");
        throw new Error("Network error. Please try again.");
      }

      try{
        text = await resp.text();
      }catch{
        throw new Error("Empty response from server.");
      }

      try{
        json = JSON.parse(text);
      }catch{
        throw new Error("Server returned invalid JSON.");
      }

      if (!resp.ok){
        setSyncStatus(false, "Offline");
        throw new Error(json && json.error ? json.error : `Request failed (${resp.status})`);
      }

      if (!json || json.ok !== true){
        setSyncStatus(true, "Synced");
        throw new Error((json && json.error) ? json.error : "Request failed.");
      }

      setSyncStatus(true, "Synced");
      return json.data;
    }

    /* =========================
      SHEET / MODAL
    ========================== */
    function openSheet({ title, body, footer, center=false }){
      const ov = $("#overlay");
      const sh = $("#sheet");
      $("#sheetTitle").textContent = title || "Dialog";
      const b = $("#sheetBody"); b.innerHTML = "";
      const f = $("#sheetFooter"); f.innerHTML = "";
      if (typeof body === "string") b.innerHTML = body;
      else if (body instanceof Node) b.appendChild(body);
      if (typeof footer === "string") f.innerHTML = footer;
      else if (footer instanceof Node) f.appendChild(footer);
      ov.classList.toggle("modalCenter", !!center);
      ov.classList.add("show");
      document.body.style.overflow = "hidden";
      sh.scrollTop = 0;
    }
    function closeSheet(){
      const ov = $("#overlay");
      ov.classList.remove("show");
      document.body.style.overflow = "";
      $("#sheetBody").innerHTML = "";
      $("#sheetFooter").innerHTML = "";
    }

    $("#overlay").addEventListener("click", (e)=>{
      if (e.target === $("#overlay")) closeSheet();
    });
    $("#sheetClose").addEventListener("click", closeSheet);

    /* =========================
      IMAGE HELPERS (receipt + crop)
    ========================== */
    async function fileToDataUrl(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onerror = ()=> reject(new Error("Failed to read file"));
        fr.onload = ()=> resolve(String(fr.result || ""));
        fr.readAsDataURL(file);
      });
    }

    async function compressImageDataUrl(dataUrl, maxW=1280, quality=0.82){
      try{
        const img = new Image();
        img.decoding = "async";
        img.src = dataUrl;
        await img.decode().catch(()=>new Promise(res=>{ img.onload = res; img.onerror = res; }));
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        if (!w || !h) return dataUrl;
        const scale = Math.min(1, maxW / w);
        const cw = Math.round(w * scale);
        const ch = Math.round(h * scale);
        const canvas = document.createElement("canvas");
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext("2d", { alpha:false });
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,cw,ch);
        ctx.drawImage(img, 0,0,cw,ch);
        const out = canvas.toDataURL("image/jpeg", quality);
        return out || dataUrl;
      }catch{
        return dataUrl;
      }
    }

    function showImageFullscreen(title, dataUrl){
      const wrap = document.createElement("div");
      wrap.className = "imgView";
      wrap.innerHTML = `
        <div class="imgViewHead">
          <div class="imgViewTitle">${safeText(title || "Receipt")}</div>
          <button class="iconBtn" type="button" aria-label="Close" style="width:44px;height:44px;border-radius:16px;box-shadow:none">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M7 7l10 10M17 7 7 17" stroke="currentColor" stroke-width="2.0" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <img alt="Receipt preview" src="${dataUrl}">
      `;
      const btn = $("button", wrap);
      btn.addEventListener("click", closeSheet);
      openSheet({ title: "Preview", body: wrap, footer: "", center:true });
    }

    function openCropper(dataUrl, onDone){
      const body = document.createElement("div");
      body.className = "cropWrap";
      body.innerHTML = `
        <div class="cropStage" id="cropStage">
          <canvas id="cropCanvas" width="1024" height="1024" aria-label="Crop preview"></canvas>
          <div class="cropHud">
            <div class="slider" aria-label="Zoom">
              <input type="range" id="cropZoom" min="1" max="3" step="0.01" value="1.25" />
            </div>
            <span class="badge soft">Drag to position</span>
          </div>
        </div>
        <div class="smallNote">Square crop. Pinch is not enabled; use zoom slider + drag. Export is optimized.</div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button");
      cancel.className = "btn";
      cancel.type = "button";
      cancel.textContent = "Cancel";
      const done = document.createElement("button");
      done.className = "btn primary";
      done.type = "button";
      done.textContent = "Use Photo";
      footer.appendChild(cancel);
      footer.appendChild(done);

      openSheet({ title:"Reframe Photo", body, footer });

      cancel.addEventListener("click", closeSheet);

      const canvas = $("#cropCanvas");
      const stage = $("#cropStage");
      const zoomEl = $("#cropZoom");
      const ctx = canvas.getContext("2d");
      let img = new Image();
      img.src = dataUrl;

      const view = {
        scale: parseFloat(zoomEl.value),
        x: 0,
        y: 0,
        dragging:false,
        lastX:0,lastY:0,
        imgW:0,imgH:0
      };

      function draw(){
        const cw = canvas.width, ch = canvas.height;
        ctx.clearRect(0,0,cw,ch);

        ctx.fillStyle = "#0b0c0f";
        ctx.fillRect(0,0,cw,ch);

        const iw = view.imgW, ih = view.imgH;
        if (!iw || !ih) return;

        const minScale = Math.max(cw/iw, ch/ih);
        const s = clamp(view.scale, minScale, 6);
        const dw = iw * s;
        const dh = ih * s;

        const maxOffX = Math.max(0, (dw - cw)/2);
        const maxOffY = Math.max(0, (dh - ch)/2);
        view.x = clamp(view.x, -maxOffX, maxOffX);
        view.y = clamp(view.y, -maxOffY, maxOffY);

        const dx = (cw - dw)/2 + view.x;
        const dy = (ch - dh)/2 + view.y;

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img, dx, dy, dw, dh);

        // subtle frame
        ctx.strokeStyle = "rgba(255,255,255,.10)";
        ctx.lineWidth = 4;
        ctx.strokeRect(8,8,cw-16,ch-16);
      }

      function pointerPos(ev){
        const r = stage.getBoundingClientRect();
        return { x: ev.clientX - r.left, y: ev.clientY - r.top };
      }

      function onDown(ev){
        ev.preventDefault();
        view.dragging = true;
        const p = pointerPos(ev);
        view.lastX = p.x; view.lastY = p.y;
      }
      function onMove(ev){
        if (!view.dragging) return;
        ev.preventDefault();
        const p = pointerPos(ev);
        view.x += (p.x - view.lastX);
        view.y += (p.y - view.lastY);
        view.lastX = p.x; view.lastY = p.y;
        draw();
      }
      function onUp(){
        view.dragging = false;
      }

      stage.addEventListener("pointerdown", onDown);
      stage.addEventListener("pointermove", onMove);
      stage.addEventListener("pointerup", onUp);
      stage.addEventListener("pointercancel", onUp);
      stage.addEventListener("pointerleave", onUp);

      zoomEl.addEventListener("input", ()=>{
        view.scale = parseFloat(zoomEl.value);
        draw();
      });

      img.decode?.().catch(()=>{}).finally(()=>{
        view.imgW = img.naturalWidth || 0;
        view.imgH = img.naturalHeight || 0;
        // initial scale to cover
        const minScale = Math.max(canvas.width/view.imgW, canvas.height/view.imgH);
        view.scale = Math.max(minScale, view.scale);
        zoomEl.value = String(clamp(view.scale, 1, 3));
        draw();
      });

      done.addEventListener("click", async ()=>{
        try{
          // export smaller for profile (512)
          const out = document.createElement("canvas");
          out.width = 512; out.height = 512;
          const octx = out.getContext("2d", { alpha:false });
          // draw from existing canvas to keep exact crop
          octx.imageSmoothingEnabled = true;
          octx.imageSmoothingQuality = "high";
          octx.drawImage(canvas, 0,0, out.width, out.height);
          const jpg = out.toDataURL("image/jpeg", 0.86);
          closeSheet();
          onDone && onDone(jpg);
        }catch(e){
          toast("Couldn’t crop", "Please try a different image.", "bad");
        }
      });
    }

    /* =========================
      AUTH + SESSION
    ========================== */
    function needsGate(me){
      if (!me) return true;
      const phoneOk = !!(me.phone && String(me.phone).replace(/\D/g,"").length === 10);
      const upiOk = !!(me.upi && validateUpi(me.upi));
      return !(phoneOk && upiOk && me.phone_verified === true && me.upi_verified === true);
    }

    async function boot(){
      loadTheme();
      loadSession();
      const lastTab = loadLastTab();
      state.activeTab = lastTab || "home";

      // Topbar buttons
      $("#btnLogout").addEventListener("click", ()=> logout(true));
      $("#btnRefresh").addEventListener("click", ()=> refreshActiveTab(true));
      $$(".tabBtn").forEach(b=> b.addEventListener("click", ()=> navigate(b.dataset.tab)));

      $("#gateLogout").addEventListener("click", ()=> logout(true));
      $("#gateSubmit").addEventListener("click", handleGateSubmit);

      document.addEventListener("visibilitychange", ()=>{
        if (document.visibilityState === "visible"){
          // best-effort realtime: refresh friends + notifs quickly when resuming
          if (state.session.userId) {
            if (state.activeTab === "friends") fetchFriendsSummary(true).catch(()=>{});
            if (state.activeTab === "notifs") fetchNotifications(true).catch(()=>{});
          }
        }
      });

      // initial ping (non-blocking)
      apiPing().then(ok=> setSyncStatus(ok, ok ? "Synced" : "Offline")).catch(()=>{});

      await hydrate();
      render();
      afterRender();
    }

    async function hydrate(){
      if (!state.session.userId){
        stopPolling();
        state.me = null;
        state.categories = [];
        state.txns = [];
        state.notifs = [];
        state.friendSummaries = [];
        return;
      }
      // validate session with getMe
      try{
        const me = await apiCall("getMe", { userId: state.session.userId });
        state.me = me;
        saveSession();
      }catch(e){
        logout(false);
        toast("Session expired", "Please login again.", "warn");
        return;
      }

      // preload lightweight data
      fetchCategories(false).catch(()=>{});
      fetchNotifications(false).catch(()=>{});
      fetchFriendsSummary(false).catch(()=>{});
    }
    // continue from: async function hydrate(){ ... }

    /* =========================
      DATA FETCHERS
    ========================== */
    async function fetchCategories(showToast=true){
      if (!state.session.userId) return [];
      if (isBusy("cats")) return state.categories;
      setBusy("cats", true);
      try{
        const list = await apiCall("listCategories", { userId: state.session.userId });
        state.categories = Array.isArray(list) ? list : [];
        if (showToast) toast("Updated", "Categories synced.", "good");
        return state.categories;
      }finally{
        setBusy("cats", false);
      }
    }

    async function fetchNotifications(showToast=true){
      if (!state.session.userId) return [];
      if (isBusy("notifs")) return state.notifs;
      setBusy("notifs", true);
      try{
        const list = await apiCall("listNotifications", { userId: state.session.userId });
        state.notifs = Array.isArray(list) ? list : [];
        updateNotifDot();
        if (showToast) toast("Updated", "Notifications synced.", "good");
        return state.notifs;
      }finally{
        setBusy("notifs", false);
      }
    }

    async function fetchTxns(showToast=true){
      if (!state.session.userId) return [];
      if (isBusy("txns")) return state.txns;
      setBusy("txns", true);
      try{
        const list = await apiCall("listTxns", { userId: state.session.userId });
        state.txns = Array.isArray(list) ? list : [];
        if (showToast) toast("Updated", "Transactions synced.", "good");
        return state.txns;
      }finally{
        setBusy("txns", false);
      }
    }

    async function fetchFriendsSummary(showToast=true){
      if (!state.session.userId) return [];
      if (isBusy("friendsSum")) return state.friendSummaries;
      setBusy("friendsSum", true);
      try{
        const list = await apiCall("friendTabSummary", { userId: state.session.userId });
        state.friendSummaries = Array.isArray(list) ? list : [];
        if (showToast) toast("Updated", "Friends synced.", "good");
        return state.friendSummaries;
      }finally{
        setBusy("friendsSum", false);
      }
    }

    function updateNotifDot(){
      const btn = $(`.tabBtn[data-tab="notifs"]`);
      const dot = $("#notifDot");
      if (!dot || !btn) return;
      const unread = (state.notifs || []).filter(n => n && n.isRead !== true).length;
      dot.textContent = String(unread);
      btn.classList.toggle("hasDot", unread > 0);
    }

    function updateTabDots(){
      // keep placeholders for future; currently only show notifs dot
      updateNotifDot();
    }

    /* =========================
      NAV + RENDER
    ========================== */
    function navigate(tab){
      const t = String(tab || "home");
      state.activeTab = t;
      setLastTab(t);
      $$(".tabBtn").forEach(b=>{
        const active = b.dataset.tab === t;
        b.setAttribute("aria-current", active ? "page" : "false");
      });
      render();
      afterRender();
      refreshActiveTab(false).catch(()=>{});
    }

    function render(){
      const root = $("#viewRoot");
      if (!root) return;

      // Logged out -> Auth view
      if (!state.session.userId || !state.me){
        $("#topbar").classList.remove("hide");
        $("#bottomNav").classList.add("hide");
        root.innerHTML = renderAuth();
        return;
      }

      // Logged in
      $("#bottomNav").classList.remove("hide");

      // Gate check
      if (needsGate(state.me)){
        showGate();
      }else{
        hideGate();
      }

      // Render active tab
      if (state.activeTab === "home") root.innerHTML = renderHome();
      else if (state.activeTab === "txns") root.innerHTML = renderTxns();
      else if (state.activeTab === "friends") root.innerHTML = renderFriends();
      else if (state.activeTab === "notifs") root.innerHTML = renderNotifs();
      else if (state.activeTab === "profile") root.innerHTML = renderProfile();
      else root.innerHTML = renderHome();

      updateTabDots();
    }

    function afterRender(){
      // auth bindings
      if (!state.session.userId || !state.me){
        bindAuth();
        return;
      }

      // tab bindings
      if (state.activeTab === "home") bindHome();
      if (state.activeTab === "txns") bindTxns();
      if (state.activeTab === "friends") bindFriends();
      if (state.activeTab === "notifs") bindNotifs();
      if (state.activeTab === "profile") bindProfile();

      // start polling for notifs + friends summary
      startPolling();
    }

    async function refreshActiveTab(showToast){
      if (!state.session.userId) return;
      // always refresh me first (budget + flags + balances)
      try{
        state.me = await apiCall("getMe", { userId: state.session.userId });
        saveSession();
      }catch{}

      if (state.activeTab === "home"){
        await Promise.allSettled([fetchTxns(false), fetchFriendsSummary(false), fetchNotifications(false)]);
        render(); afterRender();
        if (showToast) toast("Refreshed", "Home updated.", "good");
        return;
      }
      if (state.activeTab === "txns"){
        await fetchTxns(false);
        render(); afterRender();
        if (showToast) toast("Refreshed", "Transactions updated.", "good");
        return;
      }
      if (state.activeTab === "friends"){
        await fetchFriendsSummary(false);
        render(); afterRender();
        if (showToast) toast("Refreshed", "Friends updated.", "good");
        return;
      }
      if (state.activeTab === "notifs"){
        await fetchNotifications(false);
        render(); afterRender();
        if (showToast) toast("Refreshed", "Notifications updated.", "good");
        return;
      }
      if (state.activeTab === "profile"){
        await fetchCategories(false);
        render(); afterRender();
        if (showToast) toast("Refreshed", "Profile updated.", "good");
        return;
      }
    }

    /* =========================
      POLLING (best-effort realtime)
    ========================== */
    function startPolling(){
      if (!state.session.userId) return;
      if (state.polling.notifs) return; // already running
      state.polling.notifs = window.setInterval(()=> {
        if (!state.session.userId) return;
        fetchNotifications(false).then(()=> {
          if (state.activeTab === "notifs") { render(); afterRender(); }
        }).catch(()=>{});
      }, 7000);

      state.polling.friends = window.setInterval(()=> {
        if (!state.session.userId) return;
        fetchFriendsSummary(false).then(()=> {
          if (state.activeTab === "friends" || state.activeTab === "home") { render(); afterRender(); }
        }).catch(()=>{});
      }, 9000);
    }
    function stopPolling(){
      if (state.polling.notifs) window.clearInterval(state.polling.notifs);
      if (state.polling.friends) window.clearInterval(state.polling.friends);
      state.polling.notifs = null;
      state.polling.friends = null;
    }

    /* =========================
      GATE (phone + upi)
    ========================== */
    function showGate(){
      const g = $("#gate");
      if (!g) return;
      g.classList.add("show");
      $("#gateUser").textContent = state.me ? (state.me.email || state.me.username || state.me.userId) : "";
      // preload if already present
      $("#gatePhone").value = state.me && state.me.phone ? String(state.me.phone) : "";
      $("#gateUpi").value = state.me && state.me.upi ? String(state.me.upi) : "";
    }
    function hideGate(){
      const g = $("#gate");
      if (!g) return;
      g.classList.remove("show");
    }

    function gateErr(el, msg){
      const e = $(el);
      if (!e) return;
      if (msg){
        e.textContent = msg;
        e.classList.remove("hide");
      }else{
        e.textContent = "";
        e.classList.add("hide");
      }
    }
    function gateBanner(kind, title, sub){
      const b = $("#gateBanner");
      if (!b) return;
      b.classList.remove("hide");
      $("#gateBannerTitle").textContent = title || "Heads up";
      $("#gateBannerSub").textContent = sub || "";
      if (kind === "warn") b.style.borderColor = "rgba(255,199,79,.35)";
      else if (kind === "bad") b.style.borderColor = "rgba(255,92,92,.35)";
      else b.style.borderColor = "rgba(85,255,167,.25)";
    }

    async function handleGateSubmit(){
      gateErr("#gatePhoneErr", "");
      gateErr("#gateUpiErr", "");
      $("#gateBanner").classList.add("hide");

      const phone = validatePhone($("#gatePhone").value);
      const upi = validateUpi($("#gateUpi").value);

      if (!phone) gateErr("#gatePhoneErr", "Enter a valid 10-digit phone number.");
      if (!upi) gateErr("#gateUpiErr", "Enter a valid UPI (example: name@bank).");
      if (!phone || !upi) {
        gateBanner("warn", "Fix details", "Please correct the highlighted fields.");
        return;
      }

      const ok = await confirmTwoStep();
      if (!ok) return;

      // Call backend verify
      try{
        setBusy("gate", true);
        const me2 = await apiCall("verifyPhoneUpi", { userId: state.session.userId, phone, upi });
        state.me = me2;
        saveSession();
        toast("Verified", "Phone + UPI verified.", "good");
        hideGate();
        render(); afterRender();
      }catch(e){
        gateBanner("bad", "Couldn’t verify", e.message || "Try again.");
      }finally{
        setBusy("gate", false);
      }
    }

    /* =========================
      AUTH UI
    ========================== */
    function renderAuth(){
      return `
        <div class="centerWrap">
          <div class="card authCard">
            <div class="authHero">
              <h1>Welcome</h1>
              <p>Login or create an account to track spending, friends, and split bills — with a clean, mobile-first UI.</p>
            </div>

            <div class="seg" role="tablist" aria-label="Auth tabs">
              <button id="authTabLogin" aria-pressed="true" type="button">Login</button>
              <button id="authTabRegister" aria-pressed="false" type="button">Create</button>
            </div>

            <div id="authPane" style="margin-top:8px"></div>
          </div>
        </div>
      `;
    }

    function authLoginPane(){
      return `
        <div class="cardBody" style="padding-top:6px">
          <div class="field">
            <div class="label">Email or Username</div>
            <input class="input" id="loginUser" autocomplete="username" placeholder="you@email.com or username" />
            <div class="err hide" id="loginUserErr"></div>
          </div>
          <div class="field">
            <div class="label">Password</div>
            <input class="input" id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••" />
            <div class="err hide" id="loginPassErr"></div>
          </div>

          <div class="row" style="margin-top:14px">
            <button class="btn primary full" id="btnDoLogin" type="button">Login</button>
          </div>

          <div class="smallNote">Tip: Use Refresh button (top) if sync feels slow.</div>
        </div>
      `;
    }

    function authRegisterPane(){
      return `
        <div class="cardBody" style="padding-top:6px">
          <div class="field">
            <div class="label">Username</div>
            <input class="input" id="regUser" autocomplete="username" placeholder="yourname" />
            <div class="err hide" id="regUserErr"></div>
          </div>
          <div class="field">
            <div class="label">Email</div>
            <input class="input" id="regEmail" type="email" autocomplete="email" placeholder="you@email.com" />
            <div class="err hide" id="regEmailErr"></div>
          </div>
          <div class="field">
            <div class="label">Password</div>
            <input class="input" id="regPass" type="password" autocomplete="new-password" placeholder="Min 8 chars" />
            <div class="help" id="regPassHelp">Minimum 8 characters.</div>
            <div class="err hide" id="regPassErr"></div>
          </div>

          <div class="row" style="margin-top:14px">
            <button class="btn primary full" id="btnDoRegister" type="button">Create account</button>
          </div>
          <div class="smallNote">Password is stored as a hash in backend.</div>
        </div>
      `;
    }

    function bindAuth(){
      const pane = $("#authPane");
      const tL = $("#authTabLogin");
      const tR = $("#authTabRegister");
      if (!pane || !tL || !tR) return;

      let mode = "login";
      pane.innerHTML = authLoginPane();

      const setMode = (m)=>{
        mode = m;
        tL.setAttribute("aria-pressed", m==="login" ? "true":"false");
        tR.setAttribute("aria-pressed", m==="register" ? "true":"false");
        pane.innerHTML = m==="login" ? authLoginPane() : authRegisterPane();
        bindAuthPane(mode);
      };

      tL.addEventListener("click", ()=> setMode("login"));
      tR.addEventListener("click", ()=> setMode("register"));

      bindAuthPane(mode);
    }

    function setFieldErr(id, msg){
      const el = $(id);
      if (!el) return;
      if (msg){
        el.textContent = msg;
        el.classList.remove("hide");
      }else{
        el.textContent = "";
        el.classList.add("hide");
      }
    }

    function bindAuthPane(mode){
      if (mode === "login"){
        const btn = $("#btnDoLogin");
        btn.addEventListener("click", doLogin);
        $("#loginPass").addEventListener("keydown", (e)=>{ if (e.key==="Enter") doLogin(); });
        return;
      }
      const btn = $("#btnDoRegister");
      const pass = $("#regPass");
      pass.addEventListener("input", ()=>{
        const msg = validateRegisterPassword(pass.value);
        $("#regPassHelp").textContent = msg ? msg : "Looks good.";
        $("#regPassHelp").style.color = msg ? "var(--muted)" : "var(--good)";
      });
      btn.addEventListener("click", doRegister);
      $("#regPass").addEventListener("keydown", (e)=>{ if (e.key==="Enter") doRegister(); });
    }

    async function doLogin(){
      setFieldErr("#loginUserErr",""); setFieldErr("#loginPassErr","");
      const u = String($("#loginUser").value || "").trim();
      const p = String($("#loginPass").value || "");
      if (!u) { setFieldErr("#loginUserErr","Required."); return; }
      if (!p) { setFieldErr("#loginPassErr","Required."); return; }

      try{
        setBusy("auth", true);
        const me = await apiCall("login", { usernameOrEmail: u, password: p });
        state.session.userId = me.userId;
        state.me = me;
        saveSession();
        toast("Welcome", "Login successful.", "good");
        $("#bottomNav").classList.remove("hide");
        stopPolling();
        await hydrate();
        // if gate needed, show it
        if (needsGate(state.me)) showGate();
        // default landing
        state.activeTab = loadLastTab() || "home";
        render(); afterRender();
      }catch(e){
        toast("Login failed", e.message || "Invalid details.", "bad");
      }finally{
        setBusy("auth", false);
      }
    }

    async function doRegister(){
      setFieldErr("#regUserErr",""); setFieldErr("#regEmailErr",""); setFieldErr("#regPassErr","");
      const username = String($("#regUser").value || "").trim();
      const email = String($("#regEmail").value || "").trim();
      const password = String($("#regPass").value || "");

      if (!username) { setFieldErr("#regUserErr","Required."); return; }
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setFieldErr("#regEmailErr","Enter a valid email."); return; }
      const pwErr = validateRegisterPassword(password);
      if (pwErr) { setFieldErr("#regPassErr", pwErr); return; }

      try{
        setBusy("auth", true);
        const r = await apiCall("register", { username, email, password });
        toast("Account created", "Now login with your credentials.", "good");
        // switch to login with prefill
        $("#authTabLogin").click();
        setTimeout(()=>{
          $("#loginUser").value = email;
          $("#loginPass").focus();
        }, 50);
      }catch(e){
        toast("Couldn’t create", e.message || "Try again.", "bad");
      }finally{
        setBusy("auth", false);
      }
    }

    function logout(showToast=true){
      stopPolling();
      clearSession();
      state.categories = [];
      state.txns = [];
      state.notifs = [];
      state.friendSummaries = [];
      state.cache.friendDetail = null;
      hideGate();
      closeSheet();
      $("#bottomNav").classList.add("hide");
      render();
      afterRender();
      if (showToast) toast("Logged out", "You’ve been logged out.", "warn");
    }

    /* =========================
      HOME TAB
    ========================== */
    function homeBudgetInfo(){
      const b = Number(state.me?.monthly_budget || 0);
      const s = Number(state.me?.month_spend || 0);
      if (!b || b <= 0) return { pct: 0, text: "Set a monthly budget in Profile.", warn:false };
      const pct = clamp(Math.round((s / b) * 100), 0, 999);
      const warn = s > b;
      const text = warn ? `Over budget by ₹${fmtINR(s - b)}.` : `₹${fmtINR(b - s)} left this month.`;
      return { pct, text, warn };
    }

    function renderHome(){
      const me = state.me || {};
      const online = Number(me.online_balance || 0);
      const cash = Number(me.cash_balance || 0);
      const pending = Number(me.pending_balance || 0);
      const budget = homeBudgetInfo();

      const recent = (state.txns || []).slice(0, 5);

      return `
        <div class="grid cols2">
          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Balances</div>
                <div class="cardSub">Quick overview</div>
              </div>
              <span class="badge ${pending>0 ? "warn" : "soft"}">Pending ₹${fmtINR(pending)}</span>
            </div>
            <div class="cardBody">
              <div class="grid cols3" style="gap:12px">
                <div class="item" style="border-radius:22px">
                  <div class="itemLeft">
                    <div class="itemTitle">Online</div>
                    <div class="itemMeta"><span class="badge soft">Available</span></div>
                  </div>
                  <div class="amt big mono">₹${fmtINR(online)}</div>
                </div>
                <div class="item" style="border-radius:22px">
                  <div class="itemLeft">
                    <div class="itemTitle">Cash</div>
                    <div class="itemMeta"><span class="badge soft">In hand</span></div>
                  </div>
                  <div class="amt big mono">₹${fmtINR(cash)}</div>
                </div>
                <div class="item" style="border-radius:22px">
                  <div class="itemLeft">
                    <div class="itemTitle">This month</div>
                    <div class="itemMeta"><span class="badge ${budget.warn ? "bad" : "good"}">${budget.warn ? "Over" : "On track"}</span></div>
                  </div>
                  <div class="amt big mono">₹${fmtINR(Number(me.month_spend||0))}</div>
                </div>
              </div>

              <div style="margin-top:12px" class="${budget.warn ? "" : ""}">
                <div class="row between">
                  <div class="muted">Budget usage</div>
                  <div class="badge ${budget.warn ? "bad" : "soft"}">${budget.pct}%</div>
                </div>
                <div class="progress" style="margin-top:8px"><div style="width:${clamp(budget.pct,0,100)}%"></div></div>
                <div class="smallNote">${safeText(budget.text)}</div>
                ${budget.warn ? `<div class="banner" style="margin-top:10px">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 9v4" stroke="currentColor" stroke-width="1.9" stroke-linecap="round"/>
                    <path d="M12 17h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
                    <path d="M10.3 4.6a2 2 0 0 1 3.4 0l7.1 12.3A2 2 0 0 1 19.1 20H4.9a2 2 0 0 1-1.7-3.1l7.1-12.3Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
                  </svg>
                  <div>
                    <div class="bTitle">Budget exceeded</div>
                    <div class="bSub">Update your monthly budget in Profile to stop alerts.</div>
                  </div>
                </div>` : ``}
              </div>

              <div class="row wrap" style="margin-top:14px">
                <button class="btn primary" id="homeAddTxn" type="button">Add Transaction</button>
                <button class="btn" id="homeSplit" type="button">Split Bill</button>
                <button class="btn" id="homePayback" type="button">Payback</button>
              </div>
            </div>
          </section>

          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Friends</div>
                <div class="cardSub">Who owes whom</div>
              </div>
              <button class="btn small" id="homeRefreshFriends" type="button">Refresh</button>
            </div>
            <div class="cardBody">
              ${renderFriendSummaryList(4)}
            </div>
          </section>

          <section class="card" style="grid-column:1/-1">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Recent transactions</div>
                <div class="cardSub">Last 5 entries</div>
              </div>
              <button class="btn small" id="homeGoTxns" type="button">View all</button>
            </div>
            <div class="cardBody">
              ${recent.length ? `<div class="list">${recent.map(txnRowHtml).join("")}</div>` : `
                <div class="empty">
                  <div class="eTitle">No transactions yet</div>
                  <div>Add income/expense, friend transactions, and split bills — all will appear here.</div>
                </div>
              `}
            </div>
          </section>
        </div>
      `;
    }

    function bindHome(){
      $("#homeAddTxn")?.addEventListener("click", ()=> openCreateSelfTxn());
      $("#homeSplit")?.addEventListener("click", ()=> openCreateSplit());
      $("#homePayback")?.addEventListener("click", ()=> openFriendPayback());
      $("#homeGoTxns")?.addEventListener("click", ()=> navigate("txns"));
      $("#homeRefreshFriends")?.addEventListener("click", async ()=>{
        await fetchFriendsSummary(true);
        render(); afterRender();
      });
    }

    /* =========================
      TXN TAB
    ========================== */
    function renderTxns(){
      const list = state.txns || [];
      return `
        <section class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Transactions</div>
              <div class="cardSub">Self, Friend, and Split</div>
            </div>
            <div class="row wrap">
              <button class="btn small" id="txnsRefresh" type="button">Refresh</button>
              <button class="btn small primary" id="txnsAdd" type="button">Add</button>
            </div>
          </div>
          <div class="cardBody">
            ${list.length ? `
              <div class="list">
                ${list.map(txnRowHtml).join("")}
              </div>
            ` : `
              <div class="empty">
                <div class="eTitle">No transactions yet</div>
                <div>Create your first transaction from the Add button.</div>
              </div>
            `}
          </div>
        </section>
      `;
    }

    function bindTxns(){
      $("#txnsRefresh")?.addEventListener("click", async ()=>{
        await fetchTxns(true);
        render(); afterRender();
      });
      $("#txnsAdd")?.addEventListener("click", ()=> openTxnChooser());
      $$(".txnOpen").forEach(btn=>{
        btn.addEventListener("click", ()=> openTxnDetail(btn.dataset.id));
      });
      $$(".txnReceipt").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          const txn = (state.txns||[]).find(t=> String(t.txnId)===String(id));
          if (txn?.receiptDataUrl) showImageFullscreen("Receipt", txn.receiptDataUrl);
          else toast("No receipt", "No receipt image saved for this transaction.", "warn");
        });
      });
    }

    /* =========================
      FRIENDS TAB
    ========================== */
    function renderFriends(){
      const list = state.friendSummaries || [];
      return `
        <div class="grid cols2">
          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Friends</div>
                <div class="cardSub">Net outstanding balances</div>
              </div>
              <div class="row wrap">
                <button class="btn small" id="friendsRefresh" type="button">Refresh</button>
                <button class="btn small primary" id="friendsAdd" type="button">Add friend</button>
              </div>
            </div>
            <div class="cardBody">
              ${renderFriendSummaryList(999)}
            </div>
          </section>

          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Quick actions</div>
                <div class="cardSub">Create friend txn / payback</div>
              </div>
            </div>
            <div class="cardBody">
              <div class="row wrap">
                <button class="btn primary" id="friendsCreateTxn" type="button">Friend Txn</button>
                <button class="btn" id="friendsPayback" type="button">Payback</button>
              </div>
              <div class="smallNote">Tip: Search a username/email to send a request.</div>
            </div>
          </section>
        </div>
      `;
    }

    function bindFriends(){
      $("#friendsRefresh")?.addEventListener("click", async ()=>{
        await fetchFriendsSummary(true);
        render(); afterRender();
      });
      $("#friendsAdd")?.addEventListener("click", openSendFriendRequest);
      $("#friendsCreateTxn")?.addEventListener("click", openCreateFriendTxn);
      $("#friendsPayback")?.addEventListener("click", openFriendPayback);
      $$(".friendOpen").forEach(b=> b.addEventListener("click", ()=> openFriendActions(b.dataset.id)));
    }

    function renderFriendSummaryList(limit=999){
      const list = (state.friendSummaries || []).slice(0, limit);
      if (!list.length){
        return `
          <div class="empty">
            <div class="eTitle">No friends yet</div>
            <div>Add a friend and start tracking who owes whom.</div>
            <button class="btn primary" id="${limit<10 ? "homeAddFriend" : "friendsAdd2"}" type="button" style="margin-top:10px">Add friend</button>
          </div>
        `;
      }
      return `
        <div class="list">
          ${list.map(f=>{
            const dir = String(f.direction||"SETTLED");
            const badge = dir==="FRIEND_OWES_ME" ? `<span class="badge good">Friend owes me</span>` :
                          dir==="I_OWE_FRIEND" ? `<span class="badge bad">I owe</span>` :
                          `<span class="badge soft">Settled</span>`;
            return `
              <div class="item">
                <div class="itemLeft">
                  <div class="itemTitle">${safeText(f.friendName || "Friend")}</div>
                  <div class="itemMeta">
                    ${badge}
                    <span class="badge soft mono">${safeText(f.friendUserId || "")}</span>
                  </div>
                </div>
                <div class="itemRight">
                  <div class="amt mono">₹${fmtINR(f.netAmount || 0)}</div>
                  <button class="btn small friendOpen" data-id="${safeText(f.friendUserId)}" type="button">Open</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    /* =========================
      NOTIFICATIONS TAB
    ========================== */
    function renderNotifs(){
      const list = state.notifs || [];
      return `
        <section class="card">
          <div class="cardHeader">
            <div>
              <div class="cardTitle">Notifications</div>
              <div class="cardSub">Friend requests, approvals, confirmations</div>
            </div>
            <div class="row wrap">
              <button class="btn small" id="notifsRefresh" type="button">Refresh</button>
              <button class="btn small" id="notifsMarkAll" type="button">Mark all read</button>
            </div>
          </div>
          <div class="cardBody">
            ${list.length ? `<div class="list">${list.map(notifRowHtml).join("")}</div>` : `
              <div class="empty">
                <div class="eTitle">No notifications</div>
                <div>Friend requests and transaction approvals will appear here.</div>
              </div>
            `}
          </div>
        </section>
      `;
    }

    function bindNotifs(){
      $("#notifsRefresh")?.addEventListener("click", async ()=>{
        await fetchNotifications(true);
        render(); afterRender();
      });

      $("#notifsMarkAll")?.addEventListener("click", async ()=>{
        const unread = (state.notifs||[]).filter(n=>n && n.isRead !== true);
        if (!unread.length) { toast("All done", "No unread notifications.", "good"); return; }
        try{
          for (const n of unread){
            await apiCall("markNotificationRead", { userId: state.session.userId, notifId: n.notifId });
          }
          await fetchNotifications(false);
          toast("Done", "Marked all as read.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t mark all", e.message||"Try again.", "bad");
        }
      });

      $$(".notifAction").forEach(b=>{
        b.addEventListener("click", ()=> handleNotifAction(b.dataset.id, b.dataset.action));
      });
      $$(".notifOpen").forEach(b=>{
        b.addEventListener("click", ()=> openNotifDetail(b.dataset.id));
      });
    }

    function notifRowHtml(n){
      const kind = String(n.kind||"INFO");
      const isRead = n.isRead === true;
      const badge =
        kind==="FRIEND_REQUEST" ? `<span class="badge warn">Friend request</span>` :
        kind==="TXN_APPROVAL" ? `<span class="badge warn">Approval needed</span>` :
        kind==="SPLIT_APPROVAL" ? `<span class="badge warn">Split approval</span>` :
        kind==="PAYMENT_CONFIRM" ? `<span class="badge warn">Confirm payment</span>` :
        kind==="SPLIT_PAYMENT_CONFIRM" ? `<span class="badge warn">Confirm split</span>` :
        `<span class="badge soft">${safeText(kind)}</span>`;

      const actions = notifActions(n);

      return `
        <div class="item" style="opacity:${isRead ? ".82":"1"}">
          <div class="itemLeft">
            <div class="itemTitle">${safeText(n.title || "Notification")}</div>
            <div class="itemMeta">
              ${badge}
              ${isRead ? `<span class="badge soft">Read</span>` : `<span class="badge good">New</span>`}
              <span class="badge soft">${safeText(relTime(n.createdAt))}</span>
            </div>
            <div class="help">${safeText(n.message || "")}</div>
            ${actions}
          </div>
          <div class="itemRight">
            <button class="btn small notifOpen" data-id="${safeText(n.notifId)}" type="button">Open</button>
          </div>
        </div>
      `;
    }

    function notifActions(n){
      const kind = String(n.kind||"");
      // Standard actions
      const markRead = n.isRead === true ? "" : `<button class="btn small notifAction" data-id="${safeText(n.notifId)}" data-action="MARK_READ" type="button">Mark read</button>`;
      const del = `<button class="btn small notifAction" data-id="${safeText(n.notifId)}" data-action="DELETE" type="button">Delete</button>`;

      // Friend request approvals can be handled by unified notificationAction in backend
      if (kind === "FRIEND_REQUEST"){
        return `
          <div class="row wrap" style="margin-top:10px">
            <button class="btn small primary notifAction" data-id="${safeText(n.notifId)}" data-action="ACCEPT" type="button">Accept</button>
            <button class="btn small notifAction" data-id="${safeText(n.notifId)}" data-action="REJECT" type="button">Reject</button>
            ${markRead}
            ${del}
          </div>
        `;
      }

      // Txn approval (friend txn)
      if (kind === "TXN_APPROVAL"){
        return `
          <div class="row wrap" style="margin-top:10px">
            <button class="btn small primary" data-txn="${safeText(n.refId)}" id="btnApprove_${safeText(n.notifId)}" type="button">Approve</button>
            <button class="btn small" data-txn="${safeText(n.refId)}" id="btnReject_${safeText(n.notifId)}" type="button">Reject</button>
            ${markRead}
            ${del}
          </div>
        `;
      }

      // Payment confirm (friend txn receiver confirms)
      if (kind === "PAYMENT_CONFIRM"){
        return `
          <div class="row wrap" style="margin-top:10px">
            <button class="btn small primary" data-txn="${safeText(n.refId)}" id="btnRecv_${safeText(n.notifId)}" type="button">Received</button>
            <button class="btn small" data-txn="${safeText(n.refId)}" id="btnNotRecv_${safeText(n.notifId)}" type="button">Not received</button>
            ${markRead}
            ${del}
          </div>
        `;
      }

      // Split approval
      if (kind === "SPLIT_APPROVAL"){
        return `
          <div class="row wrap" style="margin-top:10px">
            <button class="btn small primary" data-txn="${safeText(n.refId)}" id="btnSplitApprove_${safeText(n.notifId)}" type="button">Approve</button>
            <button class="btn small" data-txn="${safeText(n.refId)}" id="btnSplitReject_${safeText(n.notifId)}" type="button">Reject</button>
            ${markRead}
            ${del}
          </div>
        `;
      }

      // Split payment confirm (payer confirms)
      if (kind === "SPLIT_PAYMENT_CONFIRM"){
        const meta = n.meta || {};
        const participant = meta.participantUserId || "";
        return `
          <div class="row wrap" style="margin-top:10px">
            <button class="btn small primary" data-txn="${safeText(n.refId)}" data-part="${safeText(participant)}" id="btnSplitRecv_${safeText(n.notifId)}" type="button">Received</button>
            <button class="btn small" data-txn="${safeText(n.refId)}" data-part="${safeText(participant)}" id="btnSplitNotRecv_${safeText(n.notifId)}" type="button">Not received</button>
            ${markRead}
            ${del}
          </div>
        `;
      }

      return `
        <div class="row wrap" style="margin-top:10px">
          ${markRead}
          ${del}
        </div>
      `;
    }

    async function handleNotifAction(notifId, action){
      try{
        await apiCall("notificationAction", { userId: state.session.userId, notifId, action });
        await fetchNotifications(false);
        toast("Done", "Notification updated.", "good");
        // refresh friends summary too (friend request changes)
        fetchFriendsSummary(false).catch(()=>{});
        render(); afterRender();
      }catch(e){
        toast("Action failed", e.message || "Try again.", "bad");
      }
    }

    function openNotifDetail(notifId){
      const n = (state.notifs||[]).find(x=> String(x.notifId)===String(notifId));
      if (!n) return;
      const meta = n.meta || {};
      const body = `
        <div class="card" style="border-radius:22px">
          <div class="cardBody">
            <div class="row between">
              <div class="pill">${safeText(n.kind||"INFO")}</div>
              <div class="badge soft">${safeText(relTime(n.createdAt))}</div>
            </div>
            <div style="margin-top:10px;font-weight:850;font-size:18px;letter-spacing:-.02em">${safeText(n.title||"Notification")}</div>
            <div class="smallNote" style="margin-top:6px">${safeText(n.message||"")}</div>
            <div class="divider" style="margin:14px 0"></div>
            <div class="smallNote"><strong>Ref:</strong> <span class="mono">${safeText(n.refId||"")}</span></div>
            <div class="smallNote"><strong>From:</strong> <span class="mono">${safeText(n.fromUserId||"")}</span></div>
            <div class="smallNote"><strong>Meta:</strong> <span class="mono">${safeText(JSON.stringify(meta||{}))}</span></div>
          </div>
        </div>
      `;
      const footer = document.createElement("div");
      const mark = document.createElement("button");
      mark.className = "btn";
      mark.type = "button";
      mark.textContent = n.isRead === true ? "Read" : "Mark read";
      mark.disabled = n.isRead === true;
      const del = document.createElement("button");
      del.className = "btn danger";
      del.type = "button";
      del.textContent = "Delete";
      footer.appendChild(mark);
      footer.appendChild(del);

      openSheet({ title:"Notification", body, footer });

      mark.addEventListener("click", async ()=>{
        try{
          await apiCall("markNotificationRead", { userId: state.session.userId, notifId });
          await fetchNotifications(false);
          closeSheet();
          render(); afterRender();
          toast("Marked", "Notification marked as read.", "good");
        }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
      });
      del.addEventListener("click", async ()=>{
        if (!confirm("Delete this notification?")) return;
        try{
          await apiCall("notificationAction", { userId: state.session.userId, notifId, action:"DELETE" });
          await fetchNotifications(false);
          closeSheet();
          render(); afterRender();
          toast("Deleted", "Notification deleted.", "good");
        }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
      });

      // bind special actions present in notifRowHtml (approve/reject/received etc)
      // We bind here too for safety.
      bindNotifSpecialButtons();
    }

    function bindNotifSpecialButtons(){
      // Friend txn approve/reject
      (state.notifs||[]).forEach(n=>{
        if (!n) return;
        const id = n.notifId;
        const kind = String(n.kind||"");
        if (kind==="TXN_APPROVAL"){
          const a = $(`#btnApprove_${CSS.escape(String(id))}`);
          const r = $(`#btnReject_${CSS.escape(String(id))}`);
          const txnId = String(n.refId||"");
          a?.addEventListener("click", async ()=>{
            try{
              await apiCall("friendApproveTxn", { userId: state.session.userId, txnId });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchFriendsSummary(false), fetchTxns(false)]);
              toast("Approved", "Transaction approved.", "good");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
          r?.addEventListener("click", async ()=>{
            try{
              await apiCall("friendRejectTxn", { userId: state.session.userId, txnId });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchFriendsSummary(false), fetchTxns(false)]);
              toast("Rejected", "Transaction rejected.", "warn");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
        }

        if (kind==="PAYMENT_CONFIRM"){
          const recv = $(`#btnRecv_${CSS.escape(String(id))}`);
          const nrecv = $(`#btnNotRecv_${CSS.escape(String(id))}`);
          const txnId = String(n.refId||"");
          recv?.addEventListener("click", async ()=>{
            try{
              await apiCall("friendConfirmReceived", { userId: state.session.userId, txnId, decision:"RECEIVED" });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchFriendsSummary(false), fetchTxns(false), refreshMe(false)]);
              toast("Confirmed", "Marked as received.", "good");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
          nrecv?.addEventListener("click", async ()=>{
            try{
              await apiCall("friendConfirmReceived", { userId: state.session.userId, txnId, decision:"NOT_RECEIVED" });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchFriendsSummary(false), fetchTxns(false)]);
              toast("Not received", "Payer will be asked to pay again.", "warn");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
        }

        if (kind==="SPLIT_APPROVAL"){
          const ap = $(`#btnSplitApprove_${CSS.escape(String(id))}`);
          const rj = $(`#btnSplitReject_${CSS.escape(String(id))}`);
          const txnId = String(n.refId||"");
          ap?.addEventListener("click", async ()=>{
            try{
              await apiCall("splitApprove", { userId: state.session.userId, txnId });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchTxns(false)]);
              toast("Approved", "Split approved.", "good");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
          rj?.addEventListener("click", async ()=>{
            try{
              await apiCall("splitReject", { userId: state.session.userId, txnId });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchTxns(false)]);
              toast("Rejected", "Split rejected.", "warn");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
        }

        if (kind==="SPLIT_PAYMENT_CONFIRM"){
          const recv = $(`#btnSplitRecv_${CSS.escape(String(id))}`);
          const nrecv = $(`#btnSplitNotRecv_${CSS.escape(String(id))}`);
          const txnId = String(n.refId||"");
          const participantUserId = String((n.meta||{}).participantUserId || "");
          recv?.addEventListener("click", async ()=>{
            try{
              await apiCall("splitConfirmReceived", { userId: state.session.userId, txnId, participantUserId, decision:"RECEIVED" });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchTxns(false), refreshMe(false)]);
              toast("Confirmed", "Payment received.", "good");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
          nrecv?.addEventListener("click", async ()=>{
            try{
              await apiCall("splitConfirmReceived", { userId: state.session.userId, txnId, participantUserId, decision:"NOT_RECEIVED" });
              await apiCall("notificationAction", { userId: state.session.userId, notifId:id, action:"MARK_READ" }).catch(()=>{});
              await Promise.allSettled([fetchNotifications(false), fetchTxns(false)]);
              toast("Not received", "Participant will be asked to pay again.", "warn");
              render(); afterRender();
            }catch(e){ toast("Failed", e.message||"Try again.", "bad"); }
          });
        }
      });
    }

    async function refreshMe(showToast){
      try{
        state.me = await apiCall("getMe", { userId: state.session.userId });
        saveSession();
        if (showToast) toast("Updated", "Profile refreshed.", "good");
      }catch{}
    }

    /* =========================
      PROFILE TAB
    ========================== */
    function renderProfile(){
      const me = state.me || {};
      const photo = me.photoDataUrl ? `<img alt="Profile" src="${me.photoDataUrl}" style="width:84px;height:84px;border-radius:24px;object-fit:cover;border:1px solid var(--stroke);background:rgba(0,0,0,.12)">` :
        `<div class="logo" style="width:84px;height:84px;border-radius:24px"><svg class="icon" viewBox="0 0 24 24" fill="none">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="1.7"/>
          <path d="M4 20a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
        </svg></div>`;

      const cats = (state.categories||[]);
      const grouped = {};
      cats.forEach(c=>{
        const p = String(c.parentCategory||"Other");
        if (!grouped[p]) grouped[p] = [];
        grouped[p].push(c);
      });

      return `
        <div class="grid cols2">
          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Profile</div>
                <div class="cardSub">Account + security</div>
              </div>
              <button class="btn small" id="profileTheme" type="button">Toggle theme</button>
            </div>
            <div class="cardBody">
              <div class="row" style="gap:14px;align-items:center">
                ${photo}
                <div class="grow">
                  <div style="font-weight:850;font-size:18px;letter-spacing:-.02em">${safeText(me.name || me.username || "User")}</div>
                  <div class="smallNote mono">${safeText(me.email || "")}</div>
                  <div class="row wrap" style="margin-top:10px">
                    <button class="btn small" id="btnChangePhoto" type="button">Update photo</button>
                    <button class="btn small" id="btnEditProfile" type="button">Edit profile</button>
                  </div>
                </div>
              </div>

              <div class="divider" style="margin:14px 0"></div>

              <div class="row between">
                <div>
                  <div class="muted">Phone</div>
                  <div class="mono">${safeText(me.phone || "—")}</div>
                </div>
                <span class="badge ${me.phone_verified ? "good":"warn"}">${me.phone_verified ? "Verified":"Not verified"}</span>
              </div>
              <div class="row between" style="margin-top:10px">
                <div>
                  <div class="muted">UPI</div>
                  <div class="mono">${safeText(me.upi || "—")}</div>
                </div>
                <span class="badge ${me.upi_verified ? "good":"warn"}">${me.upi_verified ? "Verified":"Not verified"}</span>
              </div>

              <div class="divider" style="margin:14px 0"></div>

              <div class="row between">
                <div>
                  <div class="muted">Monthly budget</div>
                  <div class="mono">₹${fmtINR(Number(me.monthly_budget||0))}</div>
                  <div class="smallNote">Spend this month: ₹${fmtINR(Number(me.month_spend||0))}</div>
                </div>
                <button class="btn small primary" id="btnBudget" type="button">Update</button>
              </div>

              <div class="divider" style="margin:14px 0"></div>

              <button class="btn danger full" id="profileLogout" type="button">Logout</button>
            </div>
          </section>

          <section class="card">
            <div class="cardHeader">
              <div>
                <div class="cardTitle">Categories</div>
                <div class="cardSub">Used for transactions</div>
              </div>
              <div class="row wrap">
                <button class="btn small" id="catsRefresh" type="button">Refresh</button>
                <button class="btn small primary" id="catsAdd" type="button">Add</button>
              </div>
            </div>
            <div class="cardBody">
              ${cats.length ? Object.keys(grouped).sort().map(parent=>{
                const arr = grouped[parent];
                return `
                  <div class="item" style="flex-direction:column;align-items:stretch">
                    <div class="row between">
                      <div class="itemTitle">${safeText(parent)}</div>
                      <span class="badge soft">${arr.length}</span>
                    </div>
                    <div class="row wrap" style="margin-top:8px">
                      ${arr.map(c=> `
                        <span class="pill">
                          ${safeText(c.label)}
                          <button class="iconBtn catDel" data-id="${safeText(c.catId)}" data-label="${safeText(c.label)}"
                            type="button" aria-label="Remove" style="width:34px;height:34px;border-radius:12px;box-shadow:none">
                            <svg class="icon" viewBox="0 0 24 24" fill="none">
                              <path d="M6 7h12M10 7V5h4v2M9 10v8M15 10v8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                            </svg>
                          </button>
                        </span>
                      `).join("")}
                    </div>
                  </div>
                `;
              }).join("") : `
                <div class="empty">
                  <div class="eTitle">No categories</div>
                  <div>Add categories like Food, Fuel, Rent, etc.</div>
                  <button class="btn primary" id="catsAdd2" type="button" style="margin-top:10px">Add category</button>
                </div>
              `}
            </div>
          </section>
        </div>
      `;
    }

    function bindProfile(){
      $("#profileLogout")?.addEventListener("click", ()=> logout(true));
      $("#profileTheme")?.addEventListener("click", ()=>{
        const cur = document.documentElement.getAttribute("data-theme");
        setTheme(cur === "light" ? "dark" : "light");
      });
      $("#catsRefresh")?.addEventListener("click", async ()=>{
        await fetchCategories(true);
        render(); afterRender();
      });
      $("#catsAdd")?.addEventListener("click", openAddCategory);
      $("#catsAdd2")?.addEventListener("click", openAddCategory);

      $("#btnBudget")?.addEventListener("click", openBudgetUpdate);
      $("#btnEditProfile")?.addEventListener("click", openEditProfile);
      $("#btnChangePhoto")?.addEventListener("click", openPhotoUpdate);

      $$(".catDel").forEach(b=>{
        b.addEventListener("click", ()=> removeCategory(b.dataset.id, b.dataset.label));
      });

      // empty friend list add button from home list
      $("#homeAddFriend")?.addEventListener("click", openSendFriendRequest);
      $("#friendsAdd2")?.addEventListener("click", openSendFriendRequest);
    }

    /* =========================
      SHARED ROW HTML (txns)
    ========================== */
    function txnRowHtml(t){
      const type = String(t.type||"");
      const scope = String(t.scope||"");
      const mode = String(t.mode||"");
      const amt = Number(t.amountTotal||0);

      const isIn = type==="SIMPLE_IN";
      const isOut = type==="SIMPLE_OUT";
      const isFriend = scope==="FRIEND";
      const isSplit = scope==="SPLIT";

      const title =
        isIn ? "Income" :
        isOut ? "Expense" :
        type==="PAYBACK" ? "Payback" :
        isFriend ? (type==="FRIEND_GAVE" ? "Friend paid" : "Friend took") :
        isSplit ? "Split bill" :
        "Transaction";

      const badge1 =
        isIn ? `<span class="badge good">IN</span>` :
        isOut ? `<span class="badge bad">OUT</span>` :
        `<span class="badge soft">${safeText(scope)}</span>`;

      const badge2 = `<span class="badge soft">${safeText(mode)}</span>`;
      const badge3 = t.category ? `<span class="badge soft">${safeText(t.category)}</span>` : "";

      const date = t.txnDateTime || t.createdAt || "";
      const stateBadge = t.state ? `<span class="badge soft">${safeText(t.state)}</span>` : "";

      return `
        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">${safeText(title)}</div>
            <div class="itemMeta">
              ${badge1} ${badge2} ${badge3} ${stateBadge}
              <span class="badge soft">${safeText(relTime(date))}</span>
            </div>
            ${t.notes ? `<div class="help">${safeText(t.notes)}</div>` : ``}
          </div>
          <div class="itemRight">
            <div class="amt mono ${amt>=1000 ? "big":"small"}">₹${fmtINR(amt)}</div>
            <div class="row wrap" style="justify-content:flex-end">
              <button class="btn small txnOpen" data-id="${safeText(t.txnId)}" type="button">Open</button>
              ${t.receiptDataUrl ? `<button class="btn small txnReceipt" data-id="${safeText(t.txnId)}" type="button">Receipt</button>` : ``}
            </div>
          </div>
        </div>
      `;
    }

    /* =========================
      TXN DETAIL + ACTIONS
    ========================== */
    function openTxnChooser(){
      const body = document.createElement("div");
      body.className = "list";
      body.innerHTML = `
        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Self transaction</div>
            <div class="help">Income/Expense affecting your balances</div>
          </div>
          <div class="itemRight"><button class="btn small primary" id="chooseSelf" type="button">Select</button></div>
        </div>
        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Friend transaction</div>
            <div class="help">Record money you took or friend paid for you</div>
          </div>
          <div class="itemRight"><button class="btn small primary" id="chooseFriend" type="button">Select</button></div>
        </div>
        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Split bill</div>
            <div class="help">Create group split with approvals & confirmations</div>
          </div>
          <div class="itemRight"><button class="btn small primary" id="chooseSplit" type="button">Select</button></div>
        </div>
      `;
      const footer = document.createElement("div");
      const close = document.createElement("button");
      close.className="btn"; close.type="button"; close.textContent="Close";
      footer.appendChild(close);

      openSheet({ title:"Create", body, footer });
      close.addEventListener("click", closeSheet);
      $("#chooseSelf").addEventListener("click", ()=>{ closeSheet(); openCreateSelfTxn(); });
      $("#chooseFriend").addEventListener("click", ()=>{ closeSheet(); openCreateFriendTxn(); });
      $("#chooseSplit").addEventListener("click", ()=>{ closeSheet(); openCreateSplit(); });
    }

    function openTxnDetail(txnId){
      const t = (state.txns||[]).find(x=> String(x.txnId)===String(txnId));
      if (!t) return;

      const meta = t.meta || {};
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="card" style="border-radius:22px">
          <div class="cardBody">
            <div class="row between">
              <div class="pill mono">${safeText(t.txnId)}</div>
              <span class="badge soft">${safeText(t.scope||"")}</span>
            </div>

            <div style="margin-top:10px;font-weight:900;font-size:20px;letter-spacing:-.02em">
              ₹${fmtINR(Number(t.amountTotal||0))}
            </div>

            <div class="row wrap" style="margin-top:10px">
              <span class="badge soft">Type: ${safeText(t.type||"")}</span>
              <span class="badge soft">Mode: ${safeText(t.mode||"")}</span>
              ${t.category ? `<span class="badge soft">Category: ${safeText(t.category)}</span>` : ``}
              ${t.state ? `<span class="badge soft">State: ${safeText(t.state)}</span>` : ``}
            </div>

            ${t.notes ? `<div class="divider" style="margin:14px 0"></div><div class="smallNote">${safeText(t.notes)}</div>` : ``}

            <div class="divider" style="margin:14px 0"></div>
            <div class="smallNote"><strong>Date:</strong> ${safeText(t.txnDateTime || t.createdAt || "")}</div>
            <div class="smallNote"><strong>Payer:</strong> <span class="mono">${safeText(t.payerUserId||"")}</span></div>
            <div class="smallNote"><strong>Receiver:</strong> <span class="mono">${safeText(t.receiverUserId||"")}</span></div>
            <div class="smallNote"><strong>Meta:</strong> <span class="mono">${safeText(JSON.stringify(meta||{}))}</span></div>
          </div>
        </div>
      `;

      const footer = document.createElement("div");
      const close = document.createElement("button");
      close.className = "btn"; close.type="button"; close.textContent="Close";
      footer.appendChild(close);

      // Self txn actions: edit/delete only for SIMPLE + state CONFIRM_RECEIVED (backend enforces)
      if (String(t.scope)==="SELF" && String(t.type||"").startsWith("SIMPLE_")){
        const edit = document.createElement("button");
        edit.className="btn"; edit.type="button"; edit.textContent="Edit";
        const del = document.createElement("button");
        del.className="btn danger"; del.type="button"; del.textContent="Delete";
        footer.insertBefore(edit, close);
        footer.insertBefore(del, close);

        edit.addEventListener("click", ()=>{ closeSheet(); openEditSelfTxn(t); });
        del.addEventListener("click", ()=>{ closeSheet(); deleteSelfTxn(t); });
      }

      // Split payer actions
      if (String(t.scope)==="SPLIT"){
        const meta = t.meta || {};
        const payer = String(t.lockedFromUserId || t.payerUserId || "");
        if (payer && state.session.userId === payer && String(t.state)!=="COMPLETED" && String(t.state)!=="CANCELLED"){
          const cancel = document.createElement("button");
          cancel.className="btn danger"; cancel.type="button"; cancel.textContent="Cancel split";
          footer.insertBefore(cancel, close);
          cancel.addEventListener("click", ()=>{ closeSheet(); cancelSplit(t); });
        }
      }

      openSheet({ title:"Transaction", body, footer });
      close.addEventListener("click", closeSheet);
    }

    /* =========================
      CREATE: SELF TXN
    ========================== */
    function openCreateSelfTxn(){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Type</div>
          <div class="seg" style="margin-top:6px">
            <button id="selfIn" aria-pressed="true" type="button">Income</button>
            <button id="selfOut" aria-pressed="false" type="button">Expense</button>
          </div>
        </div>

        <div class="field">
          <div class="label">Amount</div>
          <input class="input" id="selfAmt" inputmode="decimal" placeholder="e.g. 500" />
          <div class="err hide" id="selfAmtErr"></div>
        </div>

        <div class="field">
          <div class="label">Mode</div>
          <select class="select" id="selfMode">
            <option value="ONLINE">Online</option>
            <option value="CASH">Cash</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Category</div>
          <input class="input" id="selfCat" placeholder="e.g. Food" list="catList" />
          <datalist id="catList">
            ${(state.categories||[]).map(c=>`<option value="${safeText(c.label)}"></option>`).join("")}
          </datalist>
        </div>

        <div class="field">
          <div class="label">Notes</div>
          <textarea class="textarea" id="selfNotes" placeholder="Optional"></textarea>
        </div>

        <div class="field">
          <div class="label">Receipt (optional)</div>
          <input class="input" id="selfReceipt" type="file" accept="image/*" />
          <div class="smallNote">Auto-compressed before upload.</div>
        </div>

        <div class="field">
          <div class="label">Date & time</div>
          <input class="input" id="selfDT" type="datetime-local" value="${dtLocalFromIso(new Date().toISOString())}" />
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button");
      cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button");
      save.className="btn primary"; save.type="button"; save.textContent="Save";
      footer.appendChild(cancel);
      footer.appendChild(save);

      openSheet({ title:"Self transaction", body, footer });

      let type = "SIMPLE_IN";
      const setType = (t)=>{
        type = t;
        $("#selfIn").setAttribute("aria-pressed", t==="SIMPLE_IN" ? "true":"false");
        $("#selfOut").setAttribute("aria-pressed", t==="SIMPLE_OUT" ? "true":"false");
      };
      $("#selfIn").addEventListener("click", ()=> setType("SIMPLE_IN"));
      $("#selfOut").addEventListener("click", ()=> setType("SIMPLE_OUT"));

      cancel.addEventListener("click", closeSheet);

      save.addEventListener("click", async ()=>{
        $("#selfAmtErr").classList.add("hide"); $("#selfAmtErr").textContent="";
        const amt = Number($("#selfAmt").value);
        if (!isFinite(amt) || amt<=0){
          $("#selfAmtErr").textContent = "Enter a valid amount > 0.";
          $("#selfAmtErr").classList.remove("hide");
          return;
        }
        const mode = String($("#selfMode").value||"ONLINE");
        const category = String($("#selfCat").value||"").trim();
        const notes = String($("#selfNotes").value||"");
        const txnDateTime = isoFromLocal($("#selfDT").value);

        let receiptDataUrl = "";
        const file = $("#selfReceipt").files && $("#selfReceipt").files[0];
        if (file){
          const dataUrl = await fileToDataUrl(file);
          receiptDataUrl = await compressImageDataUrl(dataUrl, 1280, 0.82);
        }

        try{
          setBusy("saveSelf", true);
          await apiCall("createSelfTxn", {
            userId: state.session.userId,
            type, amount: amt, mode, category, notes, receiptDataUrl, txnDateTime
          });
          await Promise.allSettled([fetchTxns(false), refreshMe(false)]);
          closeSheet();
          toast("Saved", "Transaction created.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t save", e.message||"Try again.", "bad");
        }finally{
          setBusy("saveSelf", false);
        }
      });
    }

    function openEditSelfTxn(t){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Amount</div>
          <input class="input" id="editAmt" inputmode="decimal" value="${safeText(Number(t.amountTotal||0))}" />
          <div class="err hide" id="editAmtErr"></div>
        </div>

        <div class="field">
          <div class="label">Mode</div>
          <select class="select" id="editMode">
            <option value="ONLINE" ${String(t.mode)==="ONLINE"?"selected":""}>Online</option>
            <option value="CASH" ${String(t.mode)==="CASH"?"selected":""}>Cash</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Category</div>
          <input class="input" id="editCat" value="${safeText(t.category||"")}" list="catList2" />
          <datalist id="catList2">
            ${(state.categories||[]).map(c=>`<option value="${safeText(c.label)}"></option>`).join("")}
          </datalist>
        </div>

        <div class="field">
          <div class="label">Notes</div>
          <textarea class="textarea" id="editNotes">${safeText(t.notes||"")}</textarea>
        </div>

        <div class="field">
          <div class="label">Receipt (optional)</div>
          <input class="input" id="editReceipt" type="file" accept="image/*" />
          <div class="smallNote">If you pick a new receipt, it replaces the old one.</div>
        </div>

        <div class="field">
          <div class="label">Date & time</div>
          <input class="input" id="editDT" type="datetime-local" value="${dtLocalFromIso(t.txnDateTime || t.createdAt)}" />
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Save";
      footer.appendChild(cancel); footer.appendChild(save);

      openSheet({ title:"Edit transaction", body, footer });

      cancel.addEventListener("click", closeSheet);

      save.addEventListener("click", async ()=>{
        $("#editAmtErr").classList.add("hide"); $("#editAmtErr").textContent="";
        const amt = Number($("#editAmt").value);
        if (!isFinite(amt) || amt<=0){
          $("#editAmtErr").textContent = "Enter a valid amount > 0.";
          $("#editAmtErr").classList.remove("hide");
          return;
        }
        const mode = String($("#editMode").value||"ONLINE");
        const category = String($("#editCat").value||"").trim();
        const notes = String($("#editNotes").value||"");
        const txnDateTime = isoFromLocal($("#editDT").value);

        let receiptDataUrl = undefined;
        const file = $("#editReceipt").files && $("#editReceipt").files[0];
        if (file){
          const dataUrl = await fileToDataUrl(file);
          receiptDataUrl = await compressImageDataUrl(dataUrl, 1280, 0.82);
        }

        try{
          setBusy("editSelf", true);
          const payload = { userId: state.session.userId, txnId: t.txnId, amount: amt, mode, category, notes, txnDateTime };
          if (receiptDataUrl !== undefined) payload.receiptDataUrl = receiptDataUrl;
          await apiCall("updateSelfTxn", payload);
          await Promise.allSettled([fetchTxns(false), refreshMe(false)]);
          closeSheet();
          toast("Saved", "Transaction updated.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t update", e.message||"Try again.", "bad");
        }finally{
          setBusy("editSelf", false);
        }
      });
    }

    async function deleteSelfTxn(t){
      if (!confirm("Delete this transaction? This will revert balances accordingly.")) return;
      try{
        await apiCall("deleteTxn", { userId: state.session.userId, txnId: t.txnId });
        await Promise.allSettled([fetchTxns(false), refreshMe(false)]);
        toast("Deleted", "Transaction deleted.", "good");
        render(); afterRender();
      }catch(e){
        toast("Couldn’t delete", e.message||"Try again.", "bad");
      }
    }

    /* =========================
      FRIEND: REQUEST + TXN + PAYBACK
    ========================== */
    function openSendFriendRequest(){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Friend username / email / userId</div>
          <input class="input" id="friendTarget" placeholder="e.g. rahul or rahul@email.com" />
          <div class="help">We’ll send a request. They must accept to become friends.</div>
          <div class="err hide" id="friendTargetErr"></div>
        </div>
      `;
      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const send = document.createElement("button"); send.className="btn primary"; send.type="button"; send.textContent="Send request";
      footer.appendChild(cancel); footer.appendChild(send);

      openSheet({ title:"Add friend", body, footer });

      cancel.addEventListener("click", closeSheet);
      send.addEventListener("click", async ()=>{
        $("#friendTargetErr").classList.add("hide");
        const friend = String($("#friendTarget").value||"").trim();
        if (!friend){
          $("#friendTargetErr").textContent = "Enter a username/email/userId.";
          $("#friendTargetErr").classList.remove("hide");
          return;
        }
        try{
          await apiCall("sendFriendRequest", { userId: state.session.userId, friend });
          closeSheet();
          toast("Sent", "Friend request sent.", "good");
          await fetchNotifications(false); // they may also get notified on their side; ours not necessary but ok
          render(); afterRender();
        }catch(e){
          toast("Couldn’t send", e.message||"Try again.", "bad");
        }
      });
    }

    function friendSelectOptions(){
      const list = state.friendSummaries || [];
      return list.map(f => `<option value="${safeText(f.friendUserId)}">${safeText(f.friendName)} (${safeText(f.friendUserId)})</option>`).join("");
    }

    function openCreateFriendTxn(){
      const hasFriends = (state.friendSummaries||[]).length > 0;
      const body = document.createElement("div");
      body.innerHTML = hasFriends ? `
        <div class="field">
          <div class="label">Friend</div>
          <select class="select" id="frFriend">${friendSelectOptions()}</select>
        </div>

        <div class="field">
          <div class="label">Type</div>
          <div class="seg" style="margin-top:6px">
            <button id="frGave" aria-pressed="true" type="button">Friend paid (I received)</button>
            <button id="frTook" aria-pressed="false" type="button">I took/borrowed</button>
          </div>
          <div class="help">If you choose “I took/borrowed”, your funds are locked until approved.</div>
        </div>

        <div class="field">
          <div class="label">Amount</div>
          <input class="input" id="frAmt" inputmode="decimal" placeholder="e.g. 300" />
          <div class="err hide" id="frAmtErr"></div>
        </div>

        <div class="field">
          <div class="label">Mode</div>
          <select class="select" id="frMode">
            <option value="ONLINE">Online</option>
            <option value="CASH">Cash</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Category</div>
          <input class="input" id="frCat" placeholder="e.g. Food" list="catList3" />
          <datalist id="catList3">
            ${(state.categories || []).map(c => `
              <option value="${safeText(c.label)}"></option>
            `).join("")}
          </datalist>
        </div>

        <div class="field">
          <div class="label">Notes</div>
          <textarea class="textarea" id="frNotes" placeholder="Optional"></textarea>
        </div>

        <div class="field">
          <div class="label">Receipt (optional)</div>
          <input class="input" id="frReceipt" type="file" accept="image/*" />
          <div class="smallNote">Auto-compressed before upload.</div>
        </div>

        <div class="field">
          <div class="label">Date & time</div>
          <input class="input" id="frDT" type="datetime-local" value="${dtLocalFromIso(new Date().toISOString())}" />
        </div>
      ` : `
        <div class="empty">
          <div class="eTitle">No friends yet</div>
          <div>Add a friend first to create a friend transaction.</div>
          <button class="btn primary" id="frAddFriendFirst" type="button" style="margin-top:10px">Add friend</button>
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button");
      cancel.className = "btn";
      cancel.type = "button";
      cancel.textContent = "Cancel";

      const save = document.createElement("button");
      save.className = "btn primary";
      save.type = "button";
      save.textContent = "Save";

      footer.appendChild(cancel);
      if (hasFriends) footer.appendChild(save);

      openSheet({ title: "Friend transaction", body, footer });

      cancel.addEventListener("click", closeSheet);

      if (!hasFriends){
        $("#frAddFriendFirst")?.addEventListener("click", ()=>{
          closeSheet();
          openSendFriendRequest();
        });
        return;
      }

      // Type toggle
      let type = "FRIEND_GAVE"; // Friend paid (I received)
      const setType = (t)=>{
        type = t;
        $("#frGave")?.setAttribute("aria-pressed", t === "FRIEND_GAVE" ? "true" : "false");
        $("#frTook")?.setAttribute("aria-pressed", t === "FRIEND_TOOK" ? "true" : "false");
        save.textContent = (t === "FRIEND_TOOK") ? "Send for approval" : "Save";
      };

      $("#frGave")?.addEventListener("click", ()=> setType("FRIEND_GAVE"));
      $("#frTook")?.addEventListener("click", ()=> setType("FRIEND_TOOK"));

      save.addEventListener("click", async ()=>{
        const err = $("#frAmtErr");
        if (err){ err.classList.add("hide"); err.textContent = ""; }

        const friendUserId = String($("#frFriend").value || "").trim();
        const amt = Number($("#frAmt").value);
        const mode = String($("#frMode").value || "ONLINE");
        const category = String($("#frCat").value || "").trim();
        const notes = String($("#frNotes").value || "");
        const txnDateTime = isoFromLocal($("#frDT").value);

        if (!friendUserId){
          toast("Select friend", "Please choose a friend.", "warn");
          return;
        }
        if (!isFinite(amt) || amt <= 0){
          if (err){
            err.textContent = "Enter a valid amount > 0.";
            err.classList.remove("hide");
          }else{
            toast("Invalid amount", "Enter a valid amount > 0.", "bad");
          }
          return;
        }

        // Receipt (optional)
        let receiptDataUrl = "";
        const file = $("#frReceipt")?.files && $("#frReceipt").files[0];
        if (file){
          try{
            const dataUrl = await fileToDataUrl(file);
            receiptDataUrl = await compressImageDataUrl(dataUrl, 1280, 0.82);
          }catch{
            toast("Receipt skipped", "Could not read this image file.", "warn");
          }
        }

        try{
          setBusy("saveFriendTxn", true);
          save.disabled = true;

          // NOTE: action name must match your backend
          await apiCall("createFriendTxn", {
            userId: state.session.userId,
            friendUserId,
            type,                // FRIEND_GAVE or FRIEND_TOOK
            amount: amt,
            mode,
            category,
            notes,
            receiptDataUrl,
            txnDateTime
          });

          await Promise.allSettled([
            fetchTxns(false),
            fetchNotifications(false),
            fetchFriendsSummary(false),
            refreshMe(false)
          ]);

          closeSheet();
          toast("Saved", type === "FRIEND_TOOK" ? "Approval request sent." : "Friend transaction created.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t save", e.message || "Try again.", "bad");
        }finally{
          setBusy("saveFriendTxn", false);
          save.disabled = false;
        }
      });
    }

    function openFriendActions(friendUserId){
      const f = (state.friendSummaries||[]).find(x=> String(x.friendUserId)===String(friendUserId));
      if (!f) return;

      const body = document.createElement("div");
      body.className = "list";
      body.innerHTML = `
        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">${safeText(f.friendName || "Friend")}</div>
            <div class="itemMeta">
              <span class="badge soft mono">${safeText(f.friendUserId||"")}</span>
              <span class="badge ${String(f.direction)==="FRIEND_OWES_ME"?"good":String(f.direction)==="I_OWE_FRIEND"?"bad":"soft"}">
                ₹${fmtINR(f.netAmount||0)}
              </span>
            </div>
            <div class="help">Choose an action</div>
          </div>
        </div>

        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Create friend transaction</div>
            <div class="help">Record “Friend paid” or “I took/borrowed”</div>
          </div>
          <div class="itemRight"><button class="btn small primary" id="faCreateTxn" type="button">Open</button></div>
        </div>

        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Payback</div>
            <div class="help">Send money back / settle with confirmation</div>
          </div>
          <div class="itemRight"><button class="btn small" id="faPayback" type="button">Open</button></div>
        </div>

        <div class="item">
          <div class="itemLeft">
            <div class="itemTitle">Remove friend</div>
            <div class="help">Stops tracking and settlements</div>
          </div>
          <div class="itemRight"><button class="btn small danger" id="faRemove" type="button">Remove</button></div>
        </div>
      `;

      const footer = document.createElement("div");
      const close = document.createElement("button");
      close.className="btn"; close.type="button"; close.textContent="Close";
      footer.appendChild(close);

      openSheet({ title:"Friend", body, footer });

      close.addEventListener("click", closeSheet);

      $("#faCreateTxn")?.addEventListener("click", ()=>{
        closeSheet();
        openCreateFriendTxn();
        // preselect friend once UI exists
        setTimeout(()=>{
          const sel = $("#frFriend");
          if (sel) sel.value = String(friendUserId);
        }, 0);
      });

      $("#faPayback")?.addEventListener("click", ()=>{
        closeSheet();
        openFriendPayback(friendUserId);
      });

      $("#faRemove")?.addEventListener("click", async ()=>{
        if (!confirm("Remove this friend?")) return;
        try{
          await apiCall("removeFriend", { userId: state.session.userId, friendUserId });
          await Promise.allSettled([fetchFriendsSummary(false), fetchNotifications(false)]);
          closeSheet();
          toast("Removed", "Friend removed.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t remove", e.message||"Try again.", "bad");
        }
      });
    }

    function openFriendPayback(preselectFriendUserId=""){
      const hasFriends = (state.friendSummaries||[]).length > 0;
      const body = document.createElement("div");

      body.innerHTML = hasFriends ? `
        <div class="field">
          <div class="label">Friend</div>
          <select class="select" id="pbFriend">${friendSelectOptions()}</select>
        </div>

        <div class="field">
          <div class="label">Direction</div>
          <div class="seg" style="margin-top:6px">
            <button id="pbIPay" aria-pressed="true" type="button">I paid friend</button>
            <button id="pbFriendPay" aria-pressed="false" type="button">Friend paid me</button>
          </div>
          <div class="help">This creates a payback and triggers confirmation flow.</div>
        </div>

        <div class="field">
          <div class="label">Amount</div>
          <input class="input" id="pbAmt" inputmode="decimal" placeholder="e.g. 500" />
          <div class="err hide" id="pbAmtErr"></div>
        </div>

        <div class="field">
          <div class="label">Mode</div>
          <select class="select" id="pbMode">
            <option value="ONLINE">Online</option>
            <option value="CASH">Cash</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Notes</div>
          <textarea class="textarea" id="pbNotes" placeholder="Optional"></textarea>
        </div>

        <div class="field">
          <div class="label">Date & time</div>
          <input class="input" id="pbDT" type="datetime-local" value="${dtLocalFromIso(new Date().toISOString())}" />
        </div>
      ` : `
        <div class="empty">
          <div class="eTitle">No friends yet</div>
          <div>Add a friend first to create paybacks.</div>
          <button class="btn primary" id="pbAddFriendFirst" type="button" style="margin-top:10px">Add friend</button>
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Send confirmation";
      footer.appendChild(cancel);
      if (hasFriends) footer.appendChild(save);

      openSheet({ title:"Payback", body, footer });

      cancel.addEventListener("click", closeSheet);

      if (!hasFriends){
        $("#pbAddFriendFirst")?.addEventListener("click", ()=>{
          closeSheet();
          openSendFriendRequest();
        });
        return;
      }

      if (preselectFriendUserId){
        const sel = $("#pbFriend");
        if (sel) sel.value = String(preselectFriendUserId);
      }

      let direction = "I_PAID"; // I_PAID or FRIEND_PAID
      const setDir = (d)=>{
        direction = d;
        $("#pbIPay")?.setAttribute("aria-pressed", d==="I_PAID" ? "true":"false");
        $("#pbFriendPay")?.setAttribute("aria-pressed", d==="FRIEND_PAID" ? "true":"false");
      };
      $("#pbIPay")?.addEventListener("click", ()=> setDir("I_PAID"));
      $("#pbFriendPay")?.addEventListener("click", ()=> setDir("FRIEND_PAID"));

      save.addEventListener("click", async ()=>{
        $("#pbAmtErr").classList.add("hide"); $("#pbAmtErr").textContent = "";

        const friendUserId = String($("#pbFriend").value || "").trim();
        const amt = Number($("#pbAmt").value);
        const mode = String($("#pbMode").value || "ONLINE");
        const notes = String($("#pbNotes").value || "");
        const txnDateTime = isoFromLocal($("#pbDT").value);

        if (!friendUserId){
          toast("Select friend", "Please choose a friend.", "warn");
          return;
        }
        if (!isFinite(amt) || amt <= 0){
          $("#pbAmtErr").textContent = "Enter a valid amount > 0.";
          $("#pbAmtErr").classList.remove("hide");
          return;
        }

        try{
          setBusy("payback", true);
          save.disabled = true;

          // NOTE: action name must match your backend
          await apiCall("createPayback", {
            userId: state.session.userId,
            friendUserId,
            direction,     // I_PAID or FRIEND_PAID
            amount: amt,
            mode,
            notes,
            txnDateTime
          });

          await Promise.allSettled([fetchNotifications(false), fetchFriendsSummary(false), fetchTxns(false), refreshMe(false)]);
          closeSheet();
          toast("Sent", "Confirmation request sent.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t send", e.message||"Try again.", "bad");
        }finally{
          setBusy("payback", false);
          save.disabled = false;
        }
      });
    }

    /* =========================
      PROFILE: CATEGORY CRUD
    ========================== */
    function openAddCategory(){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Category name</div>
          <input class="input" id="catName" placeholder="e.g. Food" />
          <div class="err hide" id="catNameErr"></div>
        </div>
        <div class="field">
          <div class="label">Group / parent</div>
          <input class="input" id="catParent" placeholder="e.g. Living, Travel, Other" />
          <div class="help">Used only for grouping in UI.</div>
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Add";
      footer.appendChild(cancel); footer.appendChild(save);

      openSheet({ title:"Add category", body, footer });

      cancel.addEventListener("click", closeSheet);

      save.addEventListener("click", async ()=>{
        $("#catNameErr").classList.add("hide"); $("#catNameErr").textContent="";
        const label = String($("#catName").value||"").trim();
        const parentCategory = String($("#catParent").value||"").trim() || "Other";
        if (!label){
          $("#catNameErr").textContent="Required.";
          $("#catNameErr").classList.remove("hide");
          return;
        }
        try{
          await apiCall("addCategory", { userId: state.session.userId, label, parentCategory });
          await fetchCategories(false);
          closeSheet();
          toast("Added", "Category added.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t add", e.message||"Try again.", "bad");
        }
      });
    }

    async function removeCategory(catId, label){
      if (!confirm(`Remove category "${label || ""}"?`)) return;
      try{
        await apiCall("removeCategory", { userId: state.session.userId, catId });
        await fetchCategories(false);
        toast("Removed", "Category removed.", "good");
        render(); afterRender();
      }catch(e){
        toast("Couldn’t remove", e.message||"Try again.", "bad");
      }
    }

    /* =========================
      PROFILE: BUDGET + EDIT + PHOTO
    ========================== */
    function openBudgetUpdate(){
      const cur = Number(state.me?.monthly_budget || 0);
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Monthly budget (₹)</div>
          <input class="input" id="budAmt" inputmode="decimal" placeholder="e.g. 25000" value="${safeText(cur||"")}" />
          <div class="help">If spend goes above this, you’ll see an alert.</div>
          <div class="err hide" id="budErr"></div>
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Update";
      footer.appendChild(cancel); footer.appendChild(save);

      openSheet({ title:"Update budget", body, footer });

      cancel.addEventListener("click", closeSheet);

      save.addEventListener("click", async ()=>{
        $("#budErr").classList.add("hide"); $("#budErr").textContent="";
        const amt = Number($("#budAmt").value);
        if (!isFinite(amt) || amt <= 0){
          $("#budErr").textContent = "Enter a valid budget amount > 0.";
          $("#budErr").classList.remove("hide");
          return;
        }
        try{
          const me2 = await apiCall("updateMonthlyBudget", { userId: state.session.userId, monthly_budget: amt });
          state.me = me2 || state.me;
          saveSession();
          closeSheet();
          toast("Updated", "Budget updated.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t update", e.message||"Try again.", "bad");
        }
      });
    }

    function openEditProfile(){
      const me = state.me || {};
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Name</div>
          <input class="input" id="epName" value="${safeText(me.name||"")}" placeholder="Your name" />
        </div>

        <div class="field">
          <div class="label">Email (sensitive)</div>
          <input class="input" id="epEmail" type="email" value="${safeText(me.email||"")}" placeholder="you@email.com" />
          <div class="help">Sensitive updates require current password confirmation.</div>
        </div>

        <div class="field">
          <div class="label">Phone (10 digits)</div>
          <input class="input" id="epPhone" inputmode="numeric" maxlength="10" value="${safeText(me.phone||"")}" placeholder="9876543210" />
        </div>

        <div class="field">
          <div class="label">UPI ID</div>
          <input class="input" id="epUpi" value="${safeText(me.upi||"")}" placeholder="name@bank" />
        </div>

        <div class="divider" style="margin:14px 0"></div>

        <div class="field">
          <div class="label">Current password (required for sensitive changes)</div>
          <input class="input" id="epCurPw" type="password" autocomplete="current-password" placeholder="••••••••" />
          <div class="err hide" id="epCurPwErr"></div>
        </div>

        <div class="err hide" id="epErr"></div>
        <div class="help">If you change phone/UPI, you may be asked to re-verify.</div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Update";
      const pw = document.createElement("button"); pw.className="btn"; pw.type="button"; pw.textContent="Change password";
      footer.appendChild(pw);
      footer.appendChild(cancel);
      footer.appendChild(save);

      openSheet({ title:"Edit profile", body, footer });

      cancel.addEventListener("click", closeSheet);
      pw.addEventListener("click", ()=>{ closeSheet(); openChangePassword(); });

      save.addEventListener("click", async ()=>{
        $("#epErr").classList.add("hide"); $("#epErr").textContent="";
        $("#epCurPwErr").classList.add("hide"); $("#epCurPwErr").textContent="";

        const name = String($("#epName").value||"").trim();
        const email = String($("#epEmail").value||"").trim();
        const phone = String($("#epPhone").value||"").trim();
        const upi = String($("#epUpi").value||"").trim();
        const currentPassword = String($("#epCurPw").value||"");

        // determine sensitive change
        const emailChanged = email && String(email) !== String(me.email||"");
        const needCurPw = emailChanged; // you can expand this if your backend requires for phone too

        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          $("#epErr").textContent = "Enter a valid email.";
          $("#epErr").classList.remove("hide");
          return;
        }
        if (phone && !validatePhone(phone)){
          $("#epErr").textContent = "Enter a valid 10-digit phone.";
          $("#epErr").classList.remove("hide");
          return;
        }
        if (upi && !validateUpi(upi)){
          $("#epErr").textContent = "Enter a valid UPI (name@bank).";
          $("#epErr").classList.remove("hide");
          return;
        }
        if (needCurPw && !currentPassword){
          $("#epCurPwErr").textContent = "Current password required for email change.";
          $("#epCurPwErr").classList.remove("hide");
          return;
        }

        try{
          const me2 = await apiCall("updateProfile", {
            userId: state.session.userId,
            name,
            email,
            phone,
            upi,
            currentPassword: needCurPw ? currentPassword : ""
          });
          state.me = me2 || state.me;
          saveSession();

          await Promise.allSettled([fetchFriendsSummary(false), fetchNotifications(false)]);
          closeSheet();
          toast("Updated", "Profile updated.", "good");
          render(); afterRender();
        }catch(e){
          $("#epErr").textContent = e.message || "Update failed.";
          $("#epErr").classList.remove("hide");
        }
      });
    }

    function openChangePassword(){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Current password</div>
          <input class="input" id="cpCur" type="password" autocomplete="current-password" placeholder="••••••••" />
          <div class="err hide" id="cpCurErr"></div>
        </div>
        <div class="field">
          <div class="label">New password</div>
          <input class="input" id="cpNew" type="password" autocomplete="new-password" placeholder="Min 8 chars, letters + numbers" />
          <div class="help" id="cpHelp">Must contain letters and numbers.</div>
          <div class="err hide" id="cpNewErr"></div>
        </div>
        <div class="err hide" id="cpErr"></div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Update";
      footer.appendChild(cancel); footer.appendChild(save);

      openSheet({ title:"Change password", body, footer });

      cancel.addEventListener("click", closeSheet);

      $("#cpNew")?.addEventListener("input", ()=>{
        const msg = validateStrongPassword($("#cpNew").value);
        $("#cpHelp").textContent = msg ? msg : "Looks good.";
        $("#cpHelp").style.color = msg ? "var(--muted)" : "var(--good)";
      });

      save.addEventListener("click", async ()=>{
        $("#cpCurErr").classList.add("hide"); $("#cpCurErr").textContent="";
        $("#cpNewErr").classList.add("hide"); $("#cpNewErr").textContent="";
        $("#cpErr").classList.add("hide"); $("#cpErr").textContent="";

        const cur = String($("#cpCur").value||"");
        const nw = String($("#cpNew").value||"");

        if (!cur){ $("#cpCurErr").textContent="Required."; $("#cpCurErr").classList.remove("hide"); return; }
        const msg = validateStrongPassword(nw);
        if (msg){ $("#cpNewErr").textContent=msg; $("#cpNewErr").classList.remove("hide"); return; }

        try{
          await apiCall("changePassword", { userId: state.session.userId, currentPassword: cur, newPassword: nw });
          closeSheet();
          toast("Updated", "Password updated.", "good");
        }catch(e){
          $("#cpErr").textContent = e.message || "Failed.";
          $("#cpErr").classList.remove("hide");
        }
      });
    }

    function openPhotoUpdate(){
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="field">
          <div class="label">Select new photo</div>
          <input class="input" id="phFile" type="file" accept="image/*" />
          <div class="help">You can reframe before saving.</div>
        </div>
        <div class="empty" style="margin-top:10px">
          <div class="eTitle">Tip</div>
          <div>Pick a square-ish photo for best results.</div>
        </div>
      `;

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const next = document.createElement("button"); next.className="btn primary"; next.type="button"; next.textContent="Reframe";
      footer.appendChild(cancel); footer.appendChild(next);

      openSheet({ title:"Update photo", body, footer });

      cancel.addEventListener("click", closeSheet);

      next.addEventListener("click", async ()=>{
        const file = $("#phFile")?.files && $("#phFile").files[0];
        if (!file){
          toast("Select photo", "Please choose an image.", "warn");
          return;
        }
        try{
          const dataUrl = await fileToDataUrl(file);
          closeSheet();
          openCropper(dataUrl, async (croppedDataUrl)=>{
            try{
              const me2 = await apiCall("updateProfilePhoto", { userId: state.session.userId, photoDataUrl: croppedDataUrl });
              state.me = me2 || state.me;
              saveSession();
              toast("Updated", "Photo updated.", "good");
              render(); afterRender();
            }catch(e){
              toast("Couldn’t update", e.message||"Try again.", "bad");
            }
          });
        }catch{
          toast("Couldn’t read", "Try a different image.", "bad");
        }
      });
    }

    /* =========================
      SPLIT: CREATE + CANCEL
    ========================== */
    function openCreateSplit(){
      const friends = state.friendSummaries || [];
      const body = document.createElement("div");

      if (!friends.length){
        body.innerHTML = `
          <div class="empty">
            <div class="eTitle">No friends yet</div>
            <div>Add friends before creating split bills.</div>
            <button class="btn primary" id="spAddFriendFirst" type="button" style="margin-top:10px">Add friend</button>
          </div>
        `;
      }else{
        body.innerHTML = `
          <div class="field">
            <div class="label">Total amount</div>
            <input class="input" id="spAmt" inputmode="decimal" placeholder="e.g. 1200" />
            <div class="err hide" id="spAmtErr"></div>
          </div>

          <div class="field">
            <div class="label">Mode</div>
            <select class="select" id="spMode">
              <option value="ONLINE">Online</option>
              <option value="CASH">Cash</option>
            </select>
          </div>

          <div class="field">
            <div class="label">Category</div>
            <input class="input" id="spCat" placeholder="e.g. Dining" list="catListSplit" />
            <datalist id="catListSplit">
              ${(state.categories || []).map(c => `<option value="${safeText(c.label)}"></option>`).join("")}
            </datalist>
          </div>

          <div class="field">
            <div class="label">Notes</div>
            <textarea class="textarea" id="spNotes" placeholder="Optional"></textarea>
          </div>

          <div class="field">
            <div class="label">Participants</div>
            <div class="help">Select who is part of this split. They will receive approval notifications.</div>
            <div class="list" style="margin-top:10px" id="spPeople">
              ${friends.map(f=>`
                <div class="item" style="align-items:center">
                  <div class="itemLeft">
                    <div class="itemTitle">${safeText(f.friendName||"Friend")}</div>
                    <div class="itemMeta"><span class="badge soft mono">${safeText(f.friendUserId||"")}</span></div>
                  </div>
                  <div class="itemRight">
                    <label class="pill" style="cursor:pointer">
                      <input type="checkbox" class="spChk" value="${safeText(f.friendUserId)}" style="width:18px;height:18px">
                      <span>Select</span>
                    </label>
                  </div>
                </div>
              `).join("")}
            </div>
            <div class="err hide" id="spPeopleErr"></div>
          </div>

          <div class="field">
            <div class="label">Date & time</div>
            <input class="input" id="spDT" type="datetime-local" value="${dtLocalFromIso(new Date().toISOString())}" />
          </div>
        `;
      }

      const footer = document.createElement("div");
      const cancel = document.createElement("button"); cancel.className="btn"; cancel.type="button"; cancel.textContent="Cancel";
      const save = document.createElement("button"); save.className="btn primary"; save.type="button"; save.textContent="Send for approval";
      footer.appendChild(cancel);
      if (friends.length) footer.appendChild(save);

      openSheet({ title:"Split bill", body, footer });

      cancel.addEventListener("click", closeSheet);

      if (!friends.length){
        $("#spAddFriendFirst")?.addEventListener("click", ()=>{
          closeSheet();
          openSendFriendRequest();
        });
        return;
      }

      save.addEventListener("click", async ()=>{
        $("#spAmtErr").classList.add("hide"); $("#spAmtErr").textContent="";
        $("#spPeopleErr").classList.add("hide"); $("#spPeopleErr").textContent="";

        const amt = Number($("#spAmt").value);
        if (!isFinite(amt) || amt <= 0){
          $("#spAmtErr").textContent="Enter a valid amount > 0.";
          $("#spAmtErr").classList.remove("hide");
          return;
        }

        const selected = $$(".spChk").filter(x=> x.checked).map(x=> String(x.value));
        if (!selected.length){
          $("#spPeopleErr").textContent="Select at least 1 participant.";
          $("#spPeopleErr").classList.remove("hide");
          return;
        }

        const mode = String($("#spMode").value || "ONLINE");
        const category = String($("#spCat").value || "").trim();
        const notes = String($("#spNotes").value || "");
        const txnDateTime = isoFromLocal($("#spDT").value);

        try{
          setBusy("split", true);
          save.disabled = true;

          // NOTE: action name must match your backend
          await apiCall("createSplit", {
            userId: state.session.userId,
            amountTotal: amt,
            mode,
            category,
            notes,
            participants: selected,
            txnDateTime
          });

          await Promise.allSettled([fetchTxns(false), fetchNotifications(false)]);
          closeSheet();
          toast("Sent", "Split created and sent for approvals.", "good");
          render(); afterRender();
        }catch(e){
          toast("Couldn’t create", e.message||"Try again.", "bad");
        }finally{
          setBusy("split", false);
          save.disabled = false;
        }
      });
    }

    async function cancelSplit(t){
      if (!confirm("Cancel this split?")) return;
      try{
        await apiCall("cancelSplit", { userId: state.session.userId, txnId: t.txnId });
        await Promise.allSettled([fetchTxns(false), fetchNotifications(false)]);
        toast("Cancelled", "Split cancelled.", "warn");
        render(); afterRender();
      }catch(e){
        toast("Couldn’t cancel", e.message||"Try again.", "bad");
      }
    }

    /* =========================
      BOOTSTRAP FIXES (missing binds)
    ========================== */
    // Ensure empty-state buttons work even if they appear in Home/Friends render
    function bindEmptyStateButtons(){
      $("#homeAddFriend")?.addEventListener("click", openSendFriendRequest);
      $("#friendsAdd2")?.addEventListener("click", openSendFriendRequest);
    }

    // Patch afterRender to always bind those too (safe)
    const _afterRender = afterRender;
    afterRender = function(){
      _afterRender();
      bindEmptyStateButtons();
      // also ensure special notif buttons are bound on Notifs tab
      if (state.activeTab === "notifs") bindNotifSpecialButtons();
    };

    /* =========================
      START
    ========================== */
    window.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>

        
